<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" id="themeColor" content="#8774e1">
    <link rel="manifest" href="/manifest.json">
    <title>Clock Messenger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        :root {
            --primary: #8774e1;
            --primary-dark: #6b5b9e;
            --secondary: #31c4b2;
            --bg: #f5f7fb;
            --surface: #ffffff;
            --text: #1c1e21;
            --text-secondary: #65676b;
            --text-tertiary: #8e8e8e;
            --border: #e4e6eb;
            --error: #f15b6f;
            --success: #31c4b2;
            --warning: #f39c12;
            --online: #31c4b2;
            --offline: #8e8e8e;
            --pinned: #f1c40f;
            --saved: #9b59b6;
            --forwarded: #3498db;
            --replied: #e67e22;
        }

        /* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */
        [data-theme="dark"] {
            --bg: #1a1a1a;
            --surface: #2d2d2d;
            --text: #ffffff;
            --text-secondary: #b0b0b0;
            --text-tertiary: #808080;
            --border: #404040;
            --primary: #9b87e6;
            --primary-dark: #7a6ac0;
        }

        body {
            background: var(--bg);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
            transition: background 0.3s;
        }

        .app-container {
            width: 100%;
            max-width: 500px;
            height: 100vh;
            background: var(--surface);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            transition: background 0.3s;
        }

        .status-bar {
            background: var(--surface);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-connected {
            color: var(--online);
            font-size: 14px;
            font-weight: 500;
        }

        .status-disconnected {
            color: var(--error);
            font-size: 14px;
            font-weight: 500;
        }

        .notification-badge {
            position: relative;
            cursor: pointer;
        }

        .bell-icon {
            font-size: 22px;
            color: var(--text);
        }

        .bell-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--error);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .auth-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-button {
            background: var(--error);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 8px;
        }

        .logout-button:hover {
            opacity: 0.8;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: none;
            background: var(--bg);
        }

        .main-content.active {
            display: block;
        }

        .auth-screen, .contacts-screen, .chats-screen, .profile-screen, .saved-screen {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .auth-form {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            border-bottom: 2px solid var(--border);
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .auth-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .auth-input {
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: var(--bg);
            color: var(--text);
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-submit {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        .search-bar {
            background: var(--surface);
            border-radius: 20px;
            padding: 8px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .search-bar input {
            flex: 1;
            border: none;
            background: none;
            padding: 8px 0;
            font-size: 16px;
            color: var(--text);
        }

        .search-bar input:focus {
            outline: none;
        }

        .contacts-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .contacts-section {
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            padding-left: 8px;
        }

        .contact-item {
            background: var(--surface);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            position: relative;
        }

        .contact-item:hover {
            background: var(--bg);
        }

        .contact-item.pinned {
            border-left: 4px solid var(--pinned);
        }

        .contact-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            flex-shrink: 0;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text);
        }

        .contact-status {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .contact-last-seen {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .pinned-badge {
            color: var(--pinned);
            font-size: 14px;
            margin-left: 4px;
        }

        .verified-badge {
            color: var(--primary);
            font-size: 14px;
        }

        .admin-badge {
            background: var(--primary);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 4px;
        }

        .blocked-badge {
            color: var(--error);
            font-size: 12px;
            background: rgba(241, 91, 111, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }

        .group-badge {
            background: var(--secondary);
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }

        .channel-badge {
            background: var(--primary);
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }

        /* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: transform 0.2s, background 0.2s;
            z-index: 100;
        }

        .fab:hover {
            transform: scale(1.1);
            background: var(--primary-dark);
        }

        .fab-menu {
            position: fixed;
            bottom: 150px;
            right: 20px;
            background: var(--surface);
            border-radius: 12px;
            padding: 8px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 101;
            display: none;
            min-width: 200px;
        }

        .fab-menu.active {
            display: block;
        }

        .fab-menu-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text);
        }

        .fab-menu-item:hover {
            background: var(--bg);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pinned-message-bar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .pinned-icon {
            color: var(--pinned);
            font-size: 16px;
        }

        .pinned-text {
            flex: 1;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pinned-close {
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        .reply-preview {
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 8px 16px;
            animation: slideUp 0.2s ease;
        }

        .reply-content {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg);
            border-radius: 12px;
            padding: 8px 12px;
        }

        .reply-icon {
            font-size: 20px;
        }

        .reply-text-container {
            flex: 1;
            min-width: 0;
        }

        .reply-label {
            font-size: 12px;
            color: var(--primary);
            font-weight: 600;
            display: block;
            margin-bottom: 2px;
        }

        .reply-text {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        .reply-close {
            font-size: 18px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        .reply-close:hover {
            color: var(--error);
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            transition: transform 0.2s;
            cursor: pointer;
            user-select: none;
            color: var(--text);
        }

        .message:active {
            transform: scale(0.98);
        }

        .message-mine {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-other {
            align-self: flex-start;
            background: var(--surface);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        .message.pinned {
            border: 2px solid var(--pinned);
        }

        .message.edited {
            font-style: italic;
        }

        .message-forwarded {
            border-left: 4px solid var(--forwarded);
        }

        .message-replied {
            border-left: 4px solid var(--replied);
        }

        .message-sender {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--primary);
        }

        .message-time {
            font-size: 10px;
            margin-top: 4px;
            opacity: 0.7;
            text-align: right;
        }

        .message-status {
            font-size: 10px;
            margin-left: 4px;
        }

        .message-reactions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .reaction {
            background: rgba(0,0,0,0.05);
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
        }

        .reaction:hover {
            background: rgba(0,0,0,0.1);
        }

        .reaction.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary-dark);
        }

        .reaction-count {
            font-size: 11px;
            font-weight: 600;
        }

        .reaction-users-popup {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 11px;
            color: var(--text);
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
            z-index: 10;
        }

        .reaction:hover .reaction-users-popup {
            display: block;
        }

        .reaction-picker {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            border-radius: 40px;
            padding: 12px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: none;
            gap: 16px;
            z-index: 1000;
            animation: slideUp 0.2s ease;
        }

        .reaction-picker.active {
            display: flex;
        }

        .reaction-option {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            transition: transform 0.2s;
        }

        .reaction-option:hover {
            transform: scale(1.2);
            background: var(--primary);
            color: white;
        }

        .chat-input-area {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: var(--surface);
            border-top: 1px solid var(--border);
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 24px;
            font-size: 16px;
            background: var(--bg);
            color: var(--text);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .chat-send {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .attach-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--surface);
            color: var(--primary);
            border: 1px solid var(--border);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .self-destruct-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--surface);
            color: var(--warning);
            border: 1px solid var(--border);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .self-destruct-btn.active {
            background: var(--warning);
            color: white;
        }

        .chat-header {
            padding: 16px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-back {
            font-size: 24px;
            cursor: pointer;
            color: var(--primary);
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-name {
            font-weight: 600;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text);
        }

        .chat-header-status {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .chat-header-actions {
            display: flex;
            gap: 8px;
            position: relative;
        }

        .chat-header-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--primary);
        }

        .chat-menu {
            position: absolute;
            top: 40px;
            right: 0;
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 200px;
            z-index: 100;
            display: none;
        }

        .chat-menu.active {
            display: block;
        }

        .chat-menu-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text);
        }

        .chat-menu-item:hover {
            background: var(--bg);
        }

        .chat-menu-item.danger {
            color: var(--error);
        }

        .chat-menu-item.warning {
            color: var(--warning);
        }

        .profile-header {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 40px;
            margin: 0 auto 16px;
            cursor: pointer;
            position: relative;
        }

        .avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .profile-avatar-large:hover .avatar-overlay {
            opacity: 1;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }

        .profile-username {
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-size: 16px;
        }

        .profile-bio {
            color: var(--text);
            margin-bottom: 20px;
            font-size: 16px;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-weight: 600;
            font-size: 20px;
            color: var(--text);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .settings-section {
            background: var(--surface);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .settings-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text);
        }

        .settings-item-right {
            color: var(--text-secondary);
        }

        .theme-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .theme-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .theme-option.selected {
            border-color: var(--primary);
        }

        .theme-option.light {
            background: #f5f7fb;
        }

        .theme-option.dark {
            background: #1a1a1a;
        }

        .theme-option.system {
            background: linear-gradient(45deg, #f5f7fb 50%, #1a1a1a 50%);
        }

        .color-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .color-option.selected {
            border-color: var(--text);
        }

        .channel-stats {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .bottom-tabs {
            display: flex;
            justify-content: space-around;
            padding: 8px 16px;
            background: var(--surface);
            border-top: 1px solid var(--border);
        }

        .tab-button {
            background: none;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 20px;
            transition: all 0.2s;
        }

        .tab-button.active {
            background: var(--primary);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text);
        }

        .modal-input {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: 16px;
            background: var(--bg);
            color: var(--text);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-button {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-button-primary {
            background: var(--primary);
            color: white;
        }

        .modal-button-secondary {
            background: var(--border);
            color: var(--text);
        }

        .modal-button-danger {
            background: var(--error);
            color: white;
        }

        .members-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .member-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .member-item:last-child {
            border-bottom: none;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 600;
            color: var(--text);
        }

        .member-role {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .remove-member {
            color: var(--error);
            cursor: pointer;
            padding: 8px;
        }

        .notification-container {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            width: 90%;
            max-width: 400px;
        }

        .notification {
            background: var(--surface);
            border-left: 4px solid var(--primary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideDown 0.3s ease;
            color: var(--text);
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--error);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        .notification-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .notification-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-accept {
            background: var(--success);
            color: white;
        }

        .btn-decline {
            background: var(--error);
            color: white;
        }

        .hidden {
            display: none !important;
        }

        .notifications-popup {
            position: fixed;
            top: 80px;
            right: 16px;
            background: var(--surface);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 101;
            min-width: 280px;
            max-width: 320px;
            max-height: 400px;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-item {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item:hover {
            background: var(--bg);
        }

        .notification-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
            color: var(--text);
        }

        .notification-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .notification-time {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .file-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
        }

        .file-message {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .file-icon {
            font-size: 24px;
        }

        .file-name {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .typing-indicator {
            font-size: 12px;
            color: var(--text-secondary);
            padding: 4px 16px;
            font-style: italic;
        }

        .self-destruct-timer {
            font-size: 10px;
            color: var(--warning);
            margin-left: 4px;
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ */
        @media (max-width: 500px) {
            .reply-preview {
                padding: 4px 12px;
            }
            
            .reply-content {
                padding: 6px 10px;
            }
            
            .reply-icon {
                font-size: 18px;
            }
            
            .reply-label {
                font-size: 11px;
            }
            
            .reply-text {
                font-size: 13px;
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="status-bar">
            <div class="status-left">
                <div id="statusDisplay" class="status-disconnected">üî¥ –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
                <div class="notification-badge" id="notificationBell" style="display: none;">
                    <span class="bell-icon">üîî</span>
                    <span class="bell-count" id="notificationCount">0</span>
                </div>
            </div>
            <div id="authContainer">
                <button id="authButton" class="auth-button">–í–æ–π—Ç–∏</button>
                <div id="userInfo" class="user-info hidden">
                    <div id="userAvatar" class="user-avatar-small">?</div>
                    <span id="userName"></span>
                    <button id="logoutBtn" class="logout-button">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>

        <div id="authScreen" class="main-content">
            <div class="auth-screen">
                <div class="auth-form">
                    <div class="auth-tabs">
                        <button id="loginTab" class="auth-tab active">–í—Ö–æ–¥</button>
                        <button id="registerTab" class="auth-tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                    </div>
                    
                    <div id="loginForm">
                        <input type="text" id="loginEmail" class="auth-input" placeholder="Email –∏–ª–∏ username">
                        <input type="password" id="loginPassword" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
                        <button id="loginSubmit" class="auth-submit">–í–æ–π—Ç–∏</button>
                    </div>
                    
                    <div id="registerForm" class="hidden">
                        <input type="email" id="registerEmail" class="auth-input" placeholder="Email">
                        <input type="text" id="registerUsername" class="auth-input" placeholder="Username">
                        <input type="password" id="registerPassword" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
                        <input type="text" id="registerName" class="auth-input" placeholder="–ò–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                        <input type="text" id="registerBio" class="auth-input" placeholder="–û —Å–µ–±–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                        <button id="registerSubmit" class="auth-submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="contactsScreen" class="main-content">
            <div class="contacts-screen">
                <div class="search-bar">
                    <span>üîç</span>
                    <input type="text" id="searchContacts" placeholder="–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...">
                </div>
                <div id="contactsList" class="contacts-list"></div>
            </div>
        </div>

        <div id="chatsScreen" class="main-content">
            <div class="chats-screen">
                <div class="chat-header">
                    <span class="chat-back" onclick="showScreen('contacts')">‚Üê</span>
                    <div class="chat-header-info">
                        <div class="chat-header-name" id="chatName">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                        <div class="chat-header-status" id="chatStatus"></div>
                    </div>
                    <div class="chat-header-actions">
                        <button class="chat-header-btn" id="chatMenuBtn">‚ãÆ</button>
                        <div class="chat-menu" id="chatMenu"></div>
                    </div>
                </div>
                <div id="pinnedMessageBar" class="pinned-message-bar" style="display: none;">
                    <span class="pinned-icon">üìå</span>
                    <span class="pinned-text" id="pinnedMessageText"></span>
                    <span class="pinned-close" onclick="unpinCurrentMessage()">‚úï</span>
                </div>
                <div id="typingIndicator" class="typing-indicator" style="display: none;"></div>
                <div id="chatMessages" class="chat-messages"></div>
                
                <!-- –ü–∞–Ω–µ–ª—å –æ—Ç–≤–µ—Ç–∞ -->
                <div id="replyPreview" class="reply-preview" style="display: none;">
                    <div class="reply-content">
                        <span class="reply-icon">‚Ü©Ô∏è</span>
                        <div class="reply-text-container">
                            <span class="reply-label">–û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ</span>
                            <span class="reply-text" id="replyPreviewText"></span>
                        </div>
                        <span class="reply-close" onclick="cancelReply()">‚úï</span>
                    </div>
                </div>

                <!-- –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <div id="editPreview" class="reply-preview" style="display: none;">
                    <div class="reply-content">
                        <span class="reply-icon">‚úèÔ∏è</span>
                        <div class="reply-text-container">
                            <span class="reply-label">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
                            <span class="reply-text" id="editPreviewText"></span>
                        </div>
                        <span class="reply-close" onclick="cancelEdit()">‚úï</span>
                    </div>
                </div>

                <div class="chat-input-area">
                    <button class="attach-btn" id="attachFileBtn">üìé</button>
                    <button class="self-destruct-btn" id="selfDestructBtn">‚è±Ô∏è</button>
                    <input type="text" id="chatInput" class="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                    <button id="sendMessageBtn" class="chat-send" disabled>‚û§</button>
                </div>
            </div>
        </div>

        <div id="savedScreen" class="main-content">
            <div class="saved-screen">
                <div class="chat-header">
                    <span class="chat-back" onclick="showScreen('profile')">‚Üê</span>
                    <div class="chat-header-info">
                        <div class="chat-header-name">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
                        <div class="chat-header-status">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
                    </div>
                </div>
                <div id="savedMessages" class="chat-messages"></div>
            </div>
        </div>

        <div id="profileScreen" class="main-content">
            <div class="profile-screen">
                <div class="profile-header">
                    <div class="profile-avatar-large" id="profileAvatar">?</div>
                    <div class="profile-name" id="profileName"></div>
                    <div class="profile-username" id="profileUsername"></div>
                    <div class="profile-bio" id="profileBio"></div>
                    <button id="editProfileBtn" class="auth-button">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="contactsCount">0</div>
                        <div class="stat-label">–∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="savedCount">0</div>
                        <div class="stat-label">—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    
                    <div class="settings-item" onclick="showThemeSettings()">
                        <div class="settings-item-left">
                            <span>üé®</span>
                            <span>–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</span>
                        </div>
                        <div class="settings-item-right" id="currentTheme">–°–≤–µ—Ç–ª–∞—è</div>
                    </div>

                    <div class="settings-item" onclick="showPrivacySettings()">
                        <div class="settings-item-left">
                            <span>üîí</span>
                            <span>–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</span>
                        </div>
                        <div class="settings-item-right">‚öôÔ∏è</div>
                    </div>

                    <div class="settings-item" onclick="showNotificationsSettings()">
                        <div class="settings-item-left">
                            <span>üîî</span>
                            <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                        </div>
                        <div class="settings-item-right">‚öôÔ∏è</div>
                    </div>

                    <div class="settings-item" onclick="openSavedScreen()">
                        <div class="settings-item-left">
                            <span>üíæ</span>
                            <span>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
                        </div>
                        <div class="settings-item-right" id="savedCountSmall">0</div>
                    </div>

                    <div class="settings-item" onclick="showSearch()">
                        <div class="settings-item-left">
                            <span>üîç</span>
                            <span>–ü–æ–∏—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏–π</span>
                        </div>
                        <div class="settings-item-right">‚öôÔ∏è</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-tabs">
            <button class="tab-button active" data-tab="contacts">üë• –ö–æ–Ω—Ç–∞–∫—Ç—ã</button>
            <button class="tab-button" data-tab="chats">üí¨ –ß–∞—Ç—ã</button>
            <button class="tab-button" data-tab="profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (FAB) -->
    <div class="fab" id="fabButton">+</div>
    <div class="fab-menu" id="fabMenu">
        <div class="fab-menu-item" onclick="showAddFriendModal()">
            <span>üë§</span> –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞
        </div>
        <div class="fab-menu-item" onclick="showCreateGroupModal()">
            <span>üë•</span> –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ —Ä–µ–∞–∫—Ü–∏–π -->
    <div id="reactionPicker" class="reaction-picker">
        <span class="reaction-option" onclick="addReactionToSelected('üëç')">üëç</span>
        <span class="reaction-option" onclick="addReactionToSelected('‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span class="reaction-option" onclick="addReactionToSelected('üòÆ')">üòÆ</span>
        <span class="reaction-option" onclick="addReactionToSelected('üò¢')">üò¢</span>
        <span class="reaction-option" onclick="addReactionToSelected('üò°')">üò°</span>
        <span class="reaction-option" onclick="addReactionToSelected('üéâ')">üéâ</span>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="addFriendModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</div>
            <input type="text" id="addFriendInput" class="modal-input" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ @username">
            <div class="modal-buttons">
                <button id="addFriendCancel" class="modal-button modal-button-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button id="addFriendConfirm" class="modal-button modal-button-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</div>
            <input type="text" id="groupName" class="modal-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
            <input type="text" id="groupDescription" class="modal-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            <div class="modal-buttons">
                <button id="createGroupCancel" class="modal-button modal-button-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button id="createGroupConfirm" class="modal-button modal-button-primary">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="addToGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
            <input type="text" id="searchContactsForGroup" class="modal-input" placeholder="–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...">
            <div id="contactsForGroupList" class="members-list"></div>
            <div class="modal-buttons">
                <button id="addToGroupCancel" class="modal-button modal-button-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button id="addToGroupConfirm" class="modal-button modal-button-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="groupMembersModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã</div>
            <div id="groupMembersList" class="members-list"></div>
            <div class="modal-buttons">
                <button id="groupMembersClose" class="modal-button modal-button-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="createPollModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å</div>
            <input type="text" id="pollQuestion" class="modal-input" placeholder="–í–æ–ø—Ä–æ—Å">
            <div id="pollOptions">
                <input type="text" class="modal-input poll-option" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1">
                <input type="text" class="modal-input poll-option" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 2">
            </div>
            <button class="auth-button" onclick="addPollOption()" style="margin-bottom: 16px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
            <label>
                <input type="checkbox" id="pollMultiple"> –†–∞–∑—Ä–µ—à–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
            </label>
            <div class="modal-buttons">
                <button class="modal-button modal-button-secondary" onclick="closePollModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-button modal-button-primary" onclick="createPoll()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="searchModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–ü–æ–∏—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏–π</div>
            <input type="text" id="searchQuery" class="modal-input" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è">
            <select id="searchFrom" class="modal-input">
                <option value="">–í—Å–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏</option>
            </select>
            <input type="date" id="searchDate" class="modal-input">
            <div class="modal-buttons">
                <button class="modal-button modal-button-secondary" onclick="closeSearchModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="modal-button modal-button-primary" onclick="searchMessages()">–ù–∞–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>
            <input type="text" id="editName" class="modal-input" placeholder="–ò–º—è">
            <textarea id="editBio" class="modal-input" placeholder="–û —Å–µ–±–µ" rows="3"></textarea>
            <input type="file" id="editAvatarFile" accept="image/*" class="modal-input" style="padding: 8px;">
            <div class="modal-buttons">
                <button id="editProfileCancel" class="modal-button modal-button-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button id="editProfileConfirm" class="modal-button modal-button-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="themeModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</div>
            
            <div class="settings-title">–û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞</div>
            <div class="theme-options">
                <div class="theme-option light" onclick="setTheme('light')"></div>
                <div class="theme-option dark" onclick="setTheme('dark')"></div>
                <div class="theme-option system" onclick="setTheme('system')"></div>
            </div>

            <div class="settings-title">–ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç</div>
            <div class="color-options">
                <div class="color-option" style="background: #8774e1;" onclick="setAccentColor('#8774e1')"></div>
                <div class="color-option" style="background: #31c4b2;" onclick="setAccentColor('#31c4b2')"></div>
                <div class="color-option" style="background: #e67e22;" onclick="setAccentColor('#e67e22')"></div>
                <div class="color-option" style="background: #e74c3c;" onclick="setAccentColor('#e74c3c')"></div>
                <div class="color-option" style="background: #9b59b6;" onclick="setAccentColor('#9b59b6')"></div>
                <div class="color-option" style="background: #3498db;" onclick="setAccentColor('#3498db')"></div>
            </div>

            <div class="modal-buttons">
                <button class="modal-button modal-button-secondary" onclick="closeThemeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="privacyModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</div>
            
            <div class="settings-item">
                <span>–ö—Ç–æ –≤–∏–¥–∏—Ç –º–æ–π –æ–Ω–ª–∞–π–Ω</span>
                <select id="privacyLastSeen" class="auth-input" style="width: auto;">
                    <option value="everyone">–í—Å–µ</option>
                    <option value="contacts">–¢–æ–ª—å–∫–æ –∫–æ–Ω—Ç–∞–∫—Ç—ã</option>
                    <option value="nobody">–ù–∏–∫—Ç–æ</option>
                </select>
            </div>

            <div class="settings-item">
                <span>–ö—Ç–æ –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –º–Ω–µ</span>
                <select id="privacyMessages" class="auth-input" style="width: auto;">
                    <option value="everyone">–í—Å–µ</option>
                    <option value="contacts">–¢–æ–ª—å–∫–æ –∫–æ–Ω—Ç–∞–∫—Ç—ã</option>
                </select>
            </div>

            <div class="settings-item">
                <span>–ö—Ç–æ –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –≥—Ä—É–ø–ø—ã</span>
                <select id="privacyGroups" class="auth-input" style="width: auto;">
                    <option value="everyone">–í—Å–µ</option>
                    <option value="contacts">–¢–æ–ª—å–∫–æ –∫–æ–Ω—Ç–∞–∫—Ç—ã</option>
                </select>
            </div>

            <div class="settings-item">
                <span>–†–µ–∂–∏–º –Ω–µ–≤–∏–¥–∏–º–∫–∏</span>
                <input type="checkbox" id="invisibleMode">
            </div>

            <div class="modal-buttons">
                <button class="modal-button modal-button-secondary" onclick="closePrivacyModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="modal-button modal-button-primary" onclick="savePrivacySettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="notificationsModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
            
            <div class="settings-item">
                <span>–ó–≤—É–∫</span>
                <input type="checkbox" id="notifSound" checked>
            </div>

            <div class="settings-item">
                <span>–í–∏–±—Ä–∞—Ü–∏—è</span>
                <input type="checkbox" id="notifVibrate" checked>
            </div>

            <div class="settings-item">
                <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
                <input type="checkbox" id="notifPreview" checked>
            </div>

            <div class="modal-buttons">
                <button class="modal-button modal-button-secondary" onclick="closeNotificationsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="modal-button modal-button-primary" onclick="saveNotificationSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="messageOptionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="messageOptionsTitle">–î–µ–π—Å—Ç–≤–∏—è —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º</div>
            
            <div class="settings-item" id="pinMessageOption" onclick="pinMessage()">
                <span>üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å</span>
            </div>

            <div class="settings-item" id="editMessageOption" onclick="editMessage()">
                <span>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
            </div>

            <div class="settings-item" id="deleteMessageOption" onclick="deleteMessage()">
                <span>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</span>
            </div>

            <div class="settings-item" id="forwardMessageOption" onclick="forwardMessage()">
                <span>‚Ü©Ô∏è –ü–µ—Ä–µ—Å–ª–∞—Ç—å</span>
            </div>

            <div class="settings-item" id="replyMessageOption" onclick="replyToMessage()">
                <span>‚Ü©Ô∏è –û—Ç–≤–µ—Ç–∏—Ç—å</span>
            </div>

            <div class="settings-item" id="saveMessageOption" onclick="saveMessage()">
                <span>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
            </div>

            <div class="modal-buttons">
                <button class="modal-button modal-button-secondary" onclick="closeMessageOptionsModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div id="forwardModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–ü–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
            
            <div class="search-bar">
                <span>üîç</span>
                <input type="text" id="searchForwardContacts" placeholder="–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...">
            </div>

            <div id="forwardContactsList" class="members-list"></div>

            <div class="modal-buttons">
                <button class="modal-button modal-button-secondary" onclick="closeForwardModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div id="selfDestructModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–°–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ</div>
            <p style="margin-bottom: 16px;">–°–æ–æ–±—â–µ–Ω–∏–µ –∏—Å—á–µ–∑–Ω–µ—Ç —á–µ—Ä–µ–∑:</p>
            <div class="settings-item" onclick="setSelfDestruct(5)">
                <span>5 —Å–µ–∫—É–Ω–¥</span>
            </div>
            <div class="settings-item" onclick="setSelfDestruct(30)">
                <span>30 —Å–µ–∫—É–Ω–¥</span>
            </div>
            <div class="settings-item" onclick="setSelfDestruct(60)">
                <span>1 –º–∏–Ω—É—Ç–∞</span>
            </div>
            <div class="settings-item" onclick="setSelfDestruct(300)">
                <span>5 –º–∏–Ω—É—Ç</span>
            </div>
            <div class="settings-item" onclick="setSelfDestruct(0)">
                <span>–û—Ç–∫–ª—é—á–∏—Ç—å</span>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="confirmTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
            <p id="confirmMessage" style="margin-bottom: 20px; color: var(--text);"></p>
            <div class="modal-buttons">
                <button id="confirmCancel" class="modal-button modal-button-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button id="confirmOk" class="modal-button modal-button-primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="notificationContainer" class="notification-container"></div>

    <script>
        // ========== –°–û–°–¢–û–Ø–ù–ò–ï ==========
        let token = localStorage.getItem('token');
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        let contacts = JSON.parse(localStorage.getItem('contacts')) || [];
        let messages = JSON.parse(localStorage.getItem('messages')) || {};
        let savedMessages = JSON.parse(localStorage.getItem('savedMessages')) || [];
        let pinnedContacts = JSON.parse(localStorage.getItem('pinnedContacts')) || [];
        let pinnedMessages = JSON.parse(localStorage.getItem('pinnedMessages')) || {};
        let archivedChats = JSON.parse(localStorage.getItem('archivedChats')) || [];
        let currentChat = null;
        let groups = JSON.parse(localStorage.getItem('groups')) || [];
        let socket = null;
        let currentTab = 'contacts';
        let pendingRequests = [];
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let channelStats = { subscribers: 1, views: 0 };
        let blockedUsers = JSON.parse(localStorage.getItem('blockedUsers')) || [];
        let selectedContactsForGroup = [];
        let selectedMessageId = null;
        let selectedMessage = null;
        let replyingTo = null;
        let editingMessage = null;
        let forwardingMessage = null;
        let theme = localStorage.getItem('theme') || 'light';
        let accentColor = localStorage.getItem('accentColor') || '#8774e1';
        let privacySettings = JSON.parse(localStorage.getItem('privacySettings')) || {
            lastSeen: 'everyone',
            messages: 'everyone',
            groups: 'everyone',
            invisibleMode: false
        };
        let notificationSettings = JSON.parse(localStorage.getItem('notificationSettings')) || {
            sound: true,
            vibrate: true,
            preview: true
        };
        let typingTimeout = null;
        let typingUsers = {};
        let stories = [];
        let selfDestructTime = 0;
        let pollOptions = 2;

        // ID –∫–∞–Ω–∞–ª–∞ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
        const CHANNEL_ID = 'channel_clock';
        const ADMIN_ID = 'admin';
        const SAVED_ID = 'saved';

        // ========== DOM –≠–õ–ï–ú–ï–ù–¢–´ ==========
        const statusEl = document.getElementById('statusDisplay');
        const authButton = document.getElementById('authButton');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        
        const authScreen = document.getElementById('authScreen');
        const contactsScreen = document.getElementById('contactsScreen');
        const chatsScreen = document.getElementById('chatsScreen');
        const profileScreen = document.getElementById('profileScreen');
        const savedScreen = document.getElementById('savedScreen');
        
        const tabButtons = document.querySelectorAll('.tab-button');
        
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const loginSubmit = document.getElementById('loginSubmit');
        
        const registerEmail = document.getElementById('registerEmail');
        const registerUsername = document.getElementById('registerUsername');
        const registerPassword = document.getElementById('registerPassword');
        const registerName = document.getElementById('registerName');
        const registerBio = document.getElementById('registerBio');
        const registerSubmit = document.getElementById('registerSubmit');
        
        const contactsList = document.getElementById('contactsList');
        const searchContacts = document.getElementById('searchContacts');
        const fabButton = document.getElementById('fabButton');
        const fabMenu = document.getElementById('fabMenu');
        
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const attachFileBtn = document.getElementById('attachFileBtn');
        const selfDestructBtn = document.getElementById('selfDestructBtn');
        const chatName = document.getElementById('chatName');
        const chatStatus = document.getElementById('chatStatus');
        const chatMenuBtn = document.getElementById('chatMenuBtn');
        const chatMenu = document.getElementById('chatMenu');
        const pinnedMessageBar = document.getElementById('pinnedMessageBar');
        const pinnedMessageText = document.getElementById('pinnedMessageText');
        const typingIndicator = document.getElementById('typingIndicator');
        const replyPreview = document.getElementById('replyPreview');
        const replyPreviewText = document.getElementById('replyPreviewText');
        const editPreview = document.getElementById('editPreview');
        const editPreviewText = document.getElementById('editPreviewText');
        
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profileUsername = document.getElementById('profileUsername');
        const profileBio = document.getElementById('profileBio');
        const contactsCount = document.getElementById('contactsCount');
        const savedCount = document.getElementById('savedCount');
        const savedCountSmall = document.getElementById('savedCountSmall');
        const editProfileBtn = document.getElementById('editProfileBtn');
        
        const addFriendModal = document.getElementById('addFriendModal');
        const addFriendInput = document.getElementById('addFriendInput');
        const addFriendConfirm = document.getElementById('addFriendConfirm');
        const addFriendCancel = document.getElementById('addFriendCancel');
        
        const createGroupModal = document.getElementById('createGroupModal');
        const groupName = document.getElementById('groupName');
        const groupDescription = document.getElementById('groupDescription');
        const createGroupConfirm = document.getElementById('createGroupConfirm');
        const createGroupCancel = document.getElementById('createGroupCancel');
        
        const addToGroupModal = document.getElementById('addToGroupModal');
        const searchContactsForGroup = document.getElementById('searchContactsForGroup');
        const contactsForGroupList = document.getElementById('contactsForGroupList');
        const addToGroupConfirm = document.getElementById('addToGroupConfirm');
        const addToGroupCancel = document.getElementById('addToGroupCancel');
        
        const groupMembersModal = document.getElementById('groupMembersModal');
        const groupMembersList = document.getElementById('groupMembersList');
        const groupMembersClose = document.getElementById('groupMembersClose');
        
        const createPollModal = document.getElementById('createPollModal');
        const pollQuestion = document.getElementById('pollQuestion');
        const pollMultiple = document.getElementById('pollMultiple');
        
        const searchModal = document.getElementById('searchModal');
        const searchQuery = document.getElementById('searchQuery');
        const searchFrom = document.getElementById('searchFrom');
        const searchDate = document.getElementById('searchDate');
        
        const editProfileModal = document.getElementById('editProfileModal');
        const editName = document.getElementById('editName');
        const editBio = document.getElementById('editBio');
        const editAvatarFile = document.getElementById('editAvatarFile');
        const editProfileConfirm = document.getElementById('editProfileConfirm');
        const editProfileCancel = document.getElementById('editProfileCancel');
        
        const themeModal = document.getElementById('themeModal');
        const privacyModal = document.getElementById('privacyModal');
        const invisibleMode = document.getElementById('invisibleMode');
        const notificationsModal = document.getElementById('notificationsModal');
        const messageOptionsModal = document.getElementById('messageOptionsModal');
        const forwardModal = document.getElementById('forwardModal');
        const messageOptionsTitle = document.getElementById('messageOptionsTitle');
        const pinMessageOption = document.getElementById('pinMessageOption');
        const editMessageOption = document.getElementById('editMessageOption');
        const deleteMessageOption = document.getElementById('deleteMessageOption');
        const forwardMessageOption = document.getElementById('forwardMessageOption');
        const replyMessageOption = document.getElementById('replyMessageOption');
        const saveMessageOption = document.getElementById('saveMessageOption');
        const searchForwardContacts = document.getElementById('searchForwardContacts');
        const forwardContactsList = document.getElementById('forwardContactsList');
        const selfDestructModal = document.getElementById('selfDestructModal');
        
        const confirmModal = document.getElementById('confirmModal');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmOk = document.getElementById('confirmOk');
        
        const notificationBell = document.getElementById('notificationBell');
        const notificationCount = document.getElementById('notificationCount');
        const reactionPicker = document.getElementById('reactionPicker');
        
        let notificationPopup = null;

        // ========== –¢–ï–ú–´ ==========
        function applyTheme() {
            const root = document.documentElement;
            const themeColor = document.getElementById('themeColor');
            
            if (theme === 'dark') {
                root.setAttribute('data-theme', 'dark');
                themeColor.setAttribute('content', '#1a1a1a');
                document.getElementById('currentTheme').textContent = '–¢—ë–º–Ω–∞—è';
            } else if (theme === 'light') {
                root.setAttribute('data-theme', 'light');
                themeColor.setAttribute('content', '#8774e1');
                document.getElementById('currentTheme').textContent = '–°–≤–µ—Ç–ª–∞—è';
            } else {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                root.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
                themeColor.setAttribute('content', prefersDark ? '#1a1a1a' : '#8774e1');
                document.getElementById('currentTheme').textContent = '–°–∏—Å—Ç–µ–º–Ω–∞—è';
            }

            root.style.setProperty('--primary', accentColor);
            
            localStorage.setItem('theme', theme);
            localStorage.setItem('accentColor', accentColor);
        }

        function setTheme(newTheme) {
            theme = newTheme;
            applyTheme();
            
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`.theme-option.${newTheme}`)?.classList.add('selected');
        }

        function setAccentColor(color) {
            accentColor = color;
            applyTheme();
            
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function showThemeSettings() {
            themeModal.classList.add('active');
        }

        function closeThemeModal() {
            themeModal.classList.remove('active');
        }

        function showPrivacySettings() {
            document.getElementById('privacyLastSeen').value = privacySettings.lastSeen;
            document.getElementById('privacyMessages').value = privacySettings.messages;
            document.getElementById('privacyGroups').value = privacySettings.groups;
            invisibleMode.checked = privacySettings.invisibleMode || false;
            privacyModal.classList.add('active');
        }

        function closePrivacyModal() {
            privacyModal.classList.remove('active');
        }

        function savePrivacySettings() {
            privacySettings = {
                lastSeen: document.getElementById('privacyLastSeen').value,
                messages: document.getElementById('privacyMessages').value,
                groups: document.getElementById('privacyGroups').value,
                invisibleMode: invisibleMode.checked
            };
            localStorage.setItem('privacySettings', JSON.stringify(privacySettings));
            
            if (socket) {
                socket.send(JSON.stringify({
                    type: 'update_profile',
                    ...privacySettings
                }));
            }
            
            closePrivacyModal();
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
        }

        function showNotificationsSettings() {
            document.getElementById('notifSound').checked = notificationSettings.sound;
            document.getElementById('notifVibrate').checked = notificationSettings.vibrate;
            document.getElementById('notifPreview').checked = notificationSettings.preview;
            notificationsModal.classList.add('active');
        }

        function closeNotificationsModal() {
            notificationsModal.classList.remove('active');
        }

        function saveNotificationSettings() {
            notificationSettings = {
                sound: document.getElementById('notifSound').checked,
                vibrate: document.getElementById('notifVibrate').checked,
                preview: document.getElementById('notifPreview').checked
            };
            localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
            
            if (socket) {
                socket.send(JSON.stringify({
                    type: 'update_profile',
                    ...notificationSettings
                }));
            }
            
            closeNotificationsModal();
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
        }

        // ========== FAB –ú–ï–ù–Æ ==========
        fabButton.onclick = (e) => {
            e.stopPropagation();
            fabMenu.classList.toggle('active');
        };

        document.addEventListener('click', (e) => {
            if (!fabButton.contains(e.target) && !fabMenu.contains(e.target)) {
                fabMenu.classList.remove('active');
            }
        });

        function showAddFriendModal() {
            addFriendModal.classList.add('active');
            fabMenu.classList.remove('active');
        }

        function showCreateGroupModal() {
            createGroupModal.classList.add('active');
            fabMenu.classList.remove('active');
        }

        // ========== –ò–ó–ë–†–ê–ù–ù–û–ï ==========
        function saveMessage() {
            if (selectedMessage) {
                savedMessages.push({
                    ...selectedMessage,
                    savedAt: new Date().toISOString(),
                    fromChat: currentChat?.id
                });
                localStorage.setItem('savedMessages', JSON.stringify(savedMessages));
                updateSavedCount();
                closeMessageOptionsModal();
                showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ', 'success');
                
                if (socket) {
                    socket.send(JSON.stringify({
                        type: 'save_message',
                        messageId: selectedMessage.id
                    }));
                }
            }
        }

        function updateSavedCount() {
            savedCount.textContent = savedMessages.length;
            savedCountSmall.textContent = savedMessages.length;
        }

        function openSavedScreen() {
            showScreen('saved');
            renderSavedMessages();
        }

        function renderSavedMessages() {
            const container = document.getElementById('savedMessages');
            container.innerHTML = '';
            
            savedMessages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message message-other`;
                
                let content = msg.fileData ? 
                    (msg.fileType?.startsWith('image/') ? 
                        `<img src="${msg.fileData}" class="file-preview">` : 
                        `<div class="file-message"><span class="file-icon">üìé</span><div><div>${msg.fileName || '–§–∞–π–ª'}</div></div></div>`) : 
                    msg.text;
                
                msgDiv.innerHTML = `
                    <div class="message-sender">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏–∑ ${msg.fromChat || '—á–∞—Ç–∞'}</div>
                    <div>${content}</div>
                    <div class="message-time">${formatTime(msg.savedAt)}</div>
                `;
                container.appendChild(msgDiv);
            });
        }

        // ========== –ó–ê–ö–†–ï–ü–õ–ï–ù–ò–ï ==========
        function pinContact(contactId) {
            if (!pinnedContacts.includes(contactId)) {
                pinnedContacts.push(contactId);
                localStorage.setItem('pinnedContacts', JSON.stringify(pinnedContacts));
                updateContacts();
                showNotification('–ö–æ–Ω—Ç–∞–∫—Ç –∑–∞–∫—Ä–µ–ø–ª—ë–Ω', 'success');
                
                if (socket) {
                    socket.send(JSON.stringify({
                        type: 'pin_contact',
                        contactId: contactId
                    }));
                }
            }
        }

        function unpinContact(contactId) {
            pinnedContacts = pinnedContacts.filter(id => id !== contactId);
            localStorage.setItem('pinnedContacts', JSON.stringify(pinnedContacts));
            updateContacts();
            
            if (socket) {
                socket.send(JSON.stringify({
                    type: 'unpin_contact',
                    unpinId: contactId
                }));
            }
        }

        function pinMessage() {
            if (currentChat && selectedMessage) {
                if (!pinnedMessages[currentChat.id]) {
                    pinnedMessages[currentChat.id] = [];
                }
                
                if (!pinnedMessages[currentChat.id].find(m => m.id === selectedMessage.id)) {
                    pinnedMessages[currentChat.id].push({
                        ...selectedMessage,
                        pinnedBy: currentUser.id,
                        pinnedAt: new Date().toISOString()
                    });
                    
                    if (pinnedMessages[currentChat.id].length > 3) {
                        pinnedMessages[currentChat.id].shift();
                    }
                    
                    localStorage.setItem('pinnedMessages', JSON.stringify(pinnedMessages));
                    
                    if (currentChat.id === currentChat?.id) {
                        updatePinnedBar();
                    }
                    
                    if (socket) {
                        socket.send(JSON.stringify({
                            type: 'pin_message',
                            chatId: currentChat.id,
                            message: selectedMessage
                        }));
                    }
                    
                    showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ', 'success');
                }
            }
            closeMessageOptionsModal();
        }

        function unpinCurrentMessage() {
            if (currentChat && pinnedMessages[currentChat.id]?.length > 0) {
                pinnedMessages[currentChat.id].shift();
                localStorage.setItem('pinnedMessages', JSON.stringify(pinnedMessages));
                updatePinnedBar();
                
                if (socket) {
                    socket.send(JSON.stringify({
                        type: 'unpin_message',
                        chatId: currentChat.id
                    }));
                }
            }
        }

        function updatePinnedBar() {
            if (currentChat && pinnedMessages[currentChat.id]?.length > 0) {
                const pinned = pinnedMessages[currentChat.id][0];
                pinnedMessageBar.style.display = 'flex';
                pinnedMessageText.textContent = pinned.text || '–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
            } else {
                pinnedMessageBar.style.display = 'none';
            }
        }

        // ========== –†–ï–ê–ö–¶–ò–ò ==========
        function showReactionPicker(messageId, x, y) {
            selectedMessageId = messageId;
            selectedMessage = messages[currentChat?.id]?.find(m => m.id === messageId);
            reactionPicker.classList.add('active');
            
            reactionPicker.style.left = x + 'px';
            reactionPicker.style.top = (y - 60) + 'px';
            
            setTimeout(() => {
                document.addEventListener('click', closeReactionPicker);
            }, 100);
        }

        function closeReactionPicker(e) {
            if (!reactionPicker.contains(e.target)) {
                reactionPicker.classList.remove('active');
                document.removeEventListener('click', closeReactionPicker);
            }
        }

        function addReactionToSelected(reaction) {
            if (selectedMessageId && currentChat && socket) {
                const chatMessagesList = messages[currentChat.id] || [];
                const message = chatMessagesList.find(m => m.id === selectedMessageId);
                
                if (message) {
                    if (!message.reactions) message.reactions = {};
                    if (!message.reactions.users) message.reactions.users = {};
                    
                    if (message.reactions.users[reaction]?.includes(currentUser.id)) {
                        message.reactions[reaction]--;
                        message.reactions.users[reaction] = message.reactions.users[reaction].filter(id => id !== currentUser.id);
                        if (message.reactions[reaction] <= 0) {
                            delete message.reactions[reaction];
                            delete message.reactions.users[reaction];
                        }
                        
                        socket.send(JSON.stringify({
                            type: 'reaction',
                            chatId: currentChat.id,
                            messageId: selectedMessageId,
                            reaction: reaction,
                            remove: true
                        }));
                    } else {
                        for (let r in message.reactions.users) {
                            if (message.reactions.users[r]?.includes(currentUser.id)) {
                                message.reactions[r]--;
                                message.reactions.users[r] = message.reactions.users[r].filter(id => id !== currentUser.id);
                                if (message.reactions[r] <= 0) {
                                    delete message.reactions[r];
                                    delete message.reactions.users[r];
                                }
                            }
                        }
                        
                        message.reactions[reaction] = (message.reactions[reaction] || 0) + 1;
                        if (!message.reactions.users[reaction]) message.reactions.users[reaction] = [];
                        message.reactions.users[reaction].push(currentUser.id);
                        
                        socket.send(JSON.stringify({
                            type: 'reaction',
                            chatId: currentChat.id,
                            messageId: selectedMessageId,
                            reaction: reaction,
                            remove: false
                        }));
                    }
                    
                    renderMessages();
                }
                
                reactionPicker.classList.remove('active');
            }
        }

        function addReactionToSelectedFromMsg(messageId, reaction) {
            selectedMessageId = messageId;
            selectedMessage = messages[currentChat?.id]?.find(m => m.id === messageId);
            addReactionToSelected(reaction);
        }

        // ========== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï ==========
        function editMessage() {
            if (selectedMessage && selectedMessage.from === currentUser.id) {
                editingMessage = selectedMessage;
                chatInput.value = selectedMessage.text;
                editPreview.style.display = 'flex';
                editPreviewText.textContent = selectedMessage.text || '–°–æ–æ–±—â–µ–Ω–∏–µ';
                closeMessageOptionsModal();
                chatInput.focus();
            }
        }

        function cancelEdit() {
            editingMessage = null;
            chatInput.value = '';
            editPreview.style.display = 'none';
        }

        // ========== –£–î–ê–õ–ï–ù–ò–ï ==========
        function deleteMessage() {
            if (selectedMessage) {
                showConfirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', '–í—ã —É–≤–µ—Ä–µ–Ω—ã?', () => {
                    if (socket && currentChat) {
                        socket.send(JSON.stringify({
                            type: 'delete_message',
                            chatId: currentChat.id,
                            messageId: selectedMessage.id,
                            forEveryone: true
                        }));
                        
                        const chatMessagesList = messages[currentChat.id] || [];
                        messages[currentChat.id] = chatMessagesList.filter(m => m.id !== selectedMessage.id);
                        saveMessages();
                        renderMessages();
                        
                        closeMessageOptionsModal();
                        showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
                    }
                });
            }
        }

        // ========== –ü–ï–†–ï–°–´–õ–ö–ê ==========
        function forwardMessage() {
            if (selectedMessage) {
                forwardingMessage = selectedMessage;
                renderForwardContacts();
                forwardModal.classList.add('active');
                closeMessageOptionsModal();
            }
        }

        function renderForwardContacts() {
            const searchTerm = searchForwardContacts?.value?.toLowerCase() || '';
            const filtered = contacts.filter(c => 
                (c.name || '').toLowerCase().includes(searchTerm) || 
                (c.username || '').toLowerCase().includes(searchTerm)
            );
            
            forwardContactsList.innerHTML = '';
            
            filtered.forEach(contact => {
                const div = document.createElement('div');
                div.className = 'member-item';
                div.onclick = () => forwardToChat(contact);
                div.innerHTML = `
                    <div class="member-avatar">${getInitials(contact.name || contact.username)}</div>
                    <div class="member-info">
                        <div class="member-name">${contact.name || contact.username}</div>
                    </div>
                `;
                forwardContactsList.appendChild(div);
            });
        }

        function forwardToChat(contact) {
            if (forwardingMessage && socket) {
                let text = forwardingMessage.text || '';
                if (forwardingMessage.fileData) {
                    socket.send(JSON.stringify({
                        type: 'file_message',
                        to: contact.id,
                        fileName: forwardingMessage.fileName,
                        fileType: forwardingMessage.fileType,
                        fileData: forwardingMessage.fileData
                    }));
                } else {
                    socket.send(JSON.stringify({
                        type: 'message',
                        to: contact.id,
                        text: `‚Ü©Ô∏è –ü–µ—Ä–µ—Å–ª–∞–Ω–æ: ${text}`
                    }));
                }
                
                closeForwardModal();
                showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–æ', 'success');
            }
        }

        function closeForwardModal() {
            forwardModal.classList.remove('active');
            forwardingMessage = null;
        }

        // ========== –û–¢–í–ï–¢–´ ==========
        function replyToMessage() {
            if (selectedMessage) {
                replyingTo = selectedMessage;
                replyPreview.style.display = 'flex';
                replyPreviewText.textContent = selectedMessage.text || '–û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ';
                closeMessageOptionsModal();
                chatInput.focus();
            }
        }

        function cancelReply() {
            replyingTo = null;
            replyPreview.style.display = 'none';
        }

        // ========== –ú–ï–ù–Æ –°–û–û–ë–©–ï–ù–ò–Ø ==========
        function showMessageOptions(message, x, y) {
            selectedMessage = message;
            messageOptionsTitle.textContent = '–î–µ–π—Å—Ç–≤–∏—è —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º';
            
            pinMessageOption.style.display = message.from === currentUser.id ? 'flex' : 'none';
            editMessageOption.style.display = message.from === currentUser.id ? 'flex' : 'none';
            deleteMessageOption.style.display = message.from === currentUser.id ? 'flex' : 'none';
            forwardMessageOption.style.display = 'flex';
            replyMessageOption.style.display = 'flex';
            saveMessageOption.style.display = 'flex';
            
            messageOptionsModal.classList.add('active');
        }

        function closeMessageOptionsModal() {
            messageOptionsModal.classList.remove('active');
            selectedMessage = null;
        }

        // ========== –ü–ï–ß–ê–¢–ê–ï–¢ ==========
        function sendTyping() {
            if (socket && currentChat && !currentChat.id.startsWith('group_')) {
                socket.send(JSON.stringify({
                    type: 'typing',
                    chatId: currentChat.id
                }));
            }
        }

        function showTyping(userId) {
            if (!typingUsers[userId]) {
                typingUsers[userId] = true;
                updateTypingIndicator();
                
                setTimeout(() => {
                    delete typingUsers[userId];
                    updateTypingIndicator();
                }, 3000);
            }
        }

        function updateTypingIndicator() {
            const users = Object.keys(typingUsers);
            if (users.length > 0 && currentChat) {
                const names = users.map(id => {
                    const contact = contacts.find(c => c.id === id);
                    return contact?.name || id;
                });
                typingIndicator.textContent = `${names.join(', ')} ${users.length > 1 ? '–ø–µ—á–∞—Ç–∞—é—Ç' : '–ø–µ—á–∞—Ç–∞–µ—Ç'}...`;
                typingIndicator.style.display = 'block';
            } else {
                typingIndicator.style.display = 'none';
            }
        }

        // ========== –£–¢–ò–õ–ò–¢–´ ==========
        function showNotification(message, type = 'info', options = {}) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        ${options.body ? `<strong>${message}</strong><br>${options.body}` : message}
                    </div>
                    <span onclick="this.parentElement.parentElement.remove()" style="cursor: pointer;">‚úï</span>
                </div>
            `;
            container.appendChild(notification);
            
            setTimeout(() => notification.remove(), 4000);
        }

        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            if (diff < 86400000) return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            if (diff < 604800000) {
                const days = ['–≤—Å', '–ø–Ω', '–≤—Ç', '—Å—Ä', '—á—Ç', '–ø—Ç', '—Å–±'];
                return days[date.getDay()];
            }
            return date.toLocaleDateString('ru-RU');
        }

        function formatLastSeen(timestamp) {
            if (!timestamp) return '–Ω–∏–∫–æ–≥–¥–∞';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            if (diff < 86400000) return `—Å–µ–≥–æ–¥–Ω—è –≤ ${date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}`;
            if (diff < 172800000) return `–≤—á–µ—Ä–∞ –≤ ${date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}`;
            return date.toLocaleDateString('ru-RU');
        }

        function saveMessages() {
            localStorage.setItem('messages', JSON.stringify(messages));
        }

        function saveGroups() {
            localStorage.setItem('groups', JSON.stringify(groups));
        }

        function saveContacts() {
            localStorage.setItem('contacts', JSON.stringify(contacts));
        }

        function saveCurrentUser() {
            if (currentUser) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
        }

        function showConfirm(title, message, onConfirm) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmModal.classList.add('active');
            
            const originalOnClick = confirmOk.onclick;
            confirmOk.onclick = () => { 
                onConfirm(); 
                confirmModal.classList.remove('active');
                confirmOk.onclick = originalOnClick;
            };
            
            confirmCancel.onclick = () => {
                confirmModal.classList.remove('active');
            };
        }

        function logout() {
            showConfirm('–í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?', () => {
                if (socket) {
                    socket.close();
                    socket = null;
                }
                
                currentUser = null;
                token = null;
                localStorage.removeItem('token');
                localStorage.removeItem('currentUser');
                
                contacts = [];
                groups = [];
                messages = {};
                notifications = [];
                pendingRequests = [];
                blockedUsers = [];
                
                updateUIForUser();
                showScreen('auth');
                showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', 'info');
            });
        }

        logoutBtn.onclick = logout;

        // ========== –°–ò–°–¢–ï–ú–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ==========
        function addNotification(notification) {
            notifications.unshift(notification);
            if (notifications.length > 50) notifications.pop();
            localStorage.setItem('notifications', JSON.stringify(notifications));
            updateNotificationBell();
            showNotification(notification.text, 'info');
        }

        function updateNotificationBell() {
            if (notifications.length > 0) {
                notificationBell.style.display = 'block';
                notificationCount.textContent = notifications.length;
            } else {
                notificationBell.style.display = 'none';
            }
        }

        notificationBell.onclick = (e) => {
            e.stopPropagation();
            if (notificationPopup) {
                notificationPopup.remove();
                notificationPopup = null;
                return;
            }
            notificationPopup = document.createElement('div');
            notificationPopup.className = 'notifications-popup';
            let html = '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;"><h3 style="font-size: 16px;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3><span style="cursor: pointer; font-size: 18px;" onclick="this.parentElement.parentElement.remove(); notificationPopup = null;">‚úï</span></div>';
            if (notifications.length === 0) {
                html += '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>';
            } else {
                notifications.forEach(notif => {
                    html += `<div class="notification-item" onclick="openChatFromNotification('${notif.chatId}')"><div class="notification-avatar">${getInitials(notif.from)}</div><div class="notification-content"><div class="notification-title">${notif.from}</div><div class="notification-text">${notif.text}</div><div class="notification-time">${formatTime(notif.timestamp)}</div></div></div>`;
                });
            }
            notificationPopup.innerHTML = html;
            document.body.appendChild(notificationPopup);
        };

        function openChatFromNotification(chatId) {
            if (chatId === CHANNEL_ID) {
                openChannel();
            } else if (chatId === SAVED_ID) {
                openSavedScreen();
            } else {
                const contact = contacts.find(c => c.id === chatId) || groups.find(g => g.id === chatId) || { id: chatId, name: chatId };
                openChat(contact);
            }
            if (notificationPopup) { notificationPopup.remove(); notificationPopup = null; }
        }

        // ========== –û–ë–†–ê–ë–û–¢–ö–ê –ó–ê–Ø–í–û–ö ==========
        function showFriendRequestNotification(request) {
            pendingRequests.push(request);
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `<div style="margin-bottom: 8px;">${request.fromName} —Ö–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –¥—Ä—É–∑—å—è</div><div class="notification-buttons"><button class="notification-btn btn-accept" onclick="acceptRequest('${request.from}')">‚úì –ü—Ä–∏–Ω—è—Ç—å</button><button class="notification-btn btn-decline" onclick="declineRequest('${request.from}')">‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button></div>`;
            container.appendChild(notification);
            updateNotificationBell();
            setTimeout(() => notification.remove(), 10000);
        }

        window.acceptRequest = function(requesterId) {
            if (socket) {
                socket.send(JSON.stringify({ type: 'accept_friend', requesterId: requesterId }));
                pendingRequests = pendingRequests.filter(r => r.from !== requesterId);
                updateNotificationBell();
                showNotification('–í—ã –ø—Ä–∏–Ω—è–ª–∏ –∑–∞—è–≤–∫—É', 'success');
                document.querySelectorAll('.notification').forEach(n => n.remove());
            }
        };

        window.declineRequest = function(requesterId) {
            if (socket) {
                socket.send(JSON.stringify({ type: 'decline_friend', requesterId: requesterId }));
                pendingRequests = pendingRequests.filter(r => r.from !== requesterId);
                updateNotificationBell();
                showNotification('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞', 'info');
                document.querySelectorAll('.notification').forEach(n => n.remove());
            }
        };

        // ========== –§–ê–ô–õ–´ ==========
        attachFileBtn.onclick = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*,application/pdf';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                showNotification('–ó–∞–≥—Ä—É–∑–∫–∞...', 'info');
                
                const reader = new FileReader();
                reader.onload = () => {
                    if (currentChat && socket) {
                        socket.send(JSON.stringify({ 
                            type: 'file_message', 
                            to: currentChat.id, 
                            fileName: file.name, 
                            fileType: file.type, 
                            fileData: reader.result 
                        }));
                        showNotification('–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                    }
                };
                reader.readAsDataURL(file);
            };
            input.click();
        };

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ù–¢–ê–ö–¢–ê–ú–ò ==========
        function blockContact(contactId) {
            if (!blockedUsers.includes(contactId)) {
                blockedUsers.push(contactId);
                localStorage.setItem('blockedUsers', JSON.stringify(blockedUsers));
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'warning');
                updateContacts();
                
                if (socket) {
                    socket.send(JSON.stringify({
                        type: 'block_user',
                        blockedId: contactId
                    }));
                }
            }
        }

        function unblockContact(contactId) {
            blockedUsers = blockedUsers.filter(id => id !== contactId);
            localStorage.setItem('blockedUsers', JSON.stringify(blockedUsers));
            showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'success');
            updateContacts();
            
            if (socket) {
                socket.send(JSON.stringify({
                    type: 'unblock_user',
                    unblockedId: contactId
                }));
            }
        }

        function deleteContact(contactId) {
            if (socket) {
                socket.send(JSON.stringify({ type: 'delete_friend', friendId: contactId }));
                contacts = contacts.filter(c => c.id !== contactId);
                saveContacts();
                updateContacts();
                showNotification('–ö–æ–Ω—Ç–∞–∫—Ç —É–¥–∞–ª–µ–Ω', 'info');
            }
        }

        function clearChat(contactId) {
            if (!socket) {
                showNotification('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                return;
            }
            
            showConfirm('–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.', () => {
                socket.send(JSON.stringify({
                    type: 'clear_chat',
                    chatId: contactId
                }));
                
                if (messages[contactId]) {
                    messages[contactId] = [];
                    saveMessages();
                    if (currentChat && currentChat.id === contactId) {
                        renderMessages();
                    }
                }
                
                showNotification('–ß–∞—Ç –æ—á–∏—â–µ–Ω', 'success');
            });
        }

        function clearChannel() {
            if (!socket || currentUser?.id !== ADMIN_ID) {
                showNotification('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—á–∏—â–∞—Ç—å –∫–∞–Ω–∞–ª', 'error');
                return;
            }
            
            showConfirm('–û—á–∏—Å—Ç–∏—Ç—å –∫–∞–Ω–∞–ª', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.', () => {
                socket.send(JSON.stringify({
                    type: 'clear_channel'
                }));
                
                if (messages[CHANNEL_ID]) {
                    messages[CHANNEL_ID] = [];
                    saveMessages();
                    if (currentChat && currentChat.id === CHANNEL_ID) {
                        renderMessages();
                    }
                }
                
                showNotification('–ö–∞–Ω–∞–ª –æ—á–∏—â–µ–Ω', 'success');
            });
        }

        // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ì–†–£–ü–ü ==========
        function createGroup() {
            createGroupModal.classList.add('active');
        }

        function addToGroup() {
            if (!currentChat || !currentChat.id.startsWith('group_')) return;
            
            selectedContactsForGroup = [];
            renderContactsForGroup();
            addToGroupModal.classList.add('active');
        }

        function renderContactsForGroup() {
            const searchTerm = searchContactsForGroup?.value?.toLowerCase() || '';
            const filtered = contacts.filter(c => 
                (c.name || '').toLowerCase().includes(searchTerm) || 
                (c.username || '').toLowerCase().includes(searchTerm)
            );
            
            contactsForGroupList.innerHTML = '';
            
            filtered.forEach(contact => {
                const isSelected = selectedContactsForGroup.includes(contact.id);
                const div = document.createElement('div');
                div.className = 'member-item';
                div.onclick = () => toggleContactSelection(contact.id);
                div.innerHTML = `
                    <div class="member-avatar">${getInitials(contact.name || contact.username)}</div>
                    <div class="member-info">
                        <div class="member-name">${contact.name || contact.username}</div>
                    </div>
                    <input type="checkbox" ${isSelected ? 'checked' : ''} style="width: 20px; height: 20px;">
                `;
                contactsForGroupList.appendChild(div);
            });
        }

        function toggleContactSelection(contactId) {
            const index = selectedContactsForGroup.indexOf(contactId);
            if (index === -1) {
                selectedContactsForGroup.push(contactId);
            } else {
                selectedContactsForGroup.splice(index, 1);
            }
            renderContactsForGroup();
        }

        function showGroupMembers() {
            if (!currentChat || !currentChat.id.startsWith('group_')) return;
            
            const group = groups.find(g => g.id === currentChat.id);
            if (!group) return;
            
            const members = group.members || [];
            let html = '';
            
            members.forEach(memberId => {
                const member = contacts.find(c => c.id === memberId) || { name: memberId };
                const isCreator = memberId === group.createdBy;
                html += `
                    <div class="member-item">
                        <div class="member-avatar">${getInitials(member.name || memberId)}</div>
                        <div class="member-info">
                            <div class="member-name">${member.name || memberId}</div>
                            <div class="member-role">${isCreator ? 'üëë –°–æ–∑–¥–∞—Ç–µ–ª—å' : '–£—á–∞—Å—Ç–Ω–∏–∫'}</div>
                        </div>
                        ${!isCreator && currentUser.id === group.createdBy ? 
                            `<span class="remove-member" onclick="kickFromGroup('${memberId}')">‚úï</span>` : ''}
                    </div>
                `;
            });
            
            groupMembersList.innerHTML = html;
            groupMembersModal.classList.add('active');
        }

        function kickFromGroup(memberId) {
            if (!currentChat || !socket) return;
            
            showConfirm('–ò—Å–∫–ª—é—á–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏—Å–∫–ª—é—á–∏—Ç—å —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –≥—Ä—É–ø–ø—ã?', () => {
                socket.send(JSON.stringify({
                    type: 'kick_from_group',
                    groupId: currentChat.id,
                    memberId: memberId
                }));
                
                const group = groups.find(g => g.id === currentChat.id);
                if (group && group.members) {
                    group.members = group.members.filter(id => id !== memberId);
                    saveGroups();
                    if (currentChat && currentChat.id === group.id) {
                        chatStatus.textContent = `${group.members.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
                    }
                }
                
                showGroupMembers();
                showNotification('–£—á–∞—Å—Ç–Ω–∏–∫ –∏—Å–∫–ª—é—á–µ–Ω', 'success');
            });
        }

        function deleteGroup() {
            if (!currentChat || !currentChat.id.startsWith('group_')) return;
            
            showConfirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.', () => {
                if (socket) {
                    socket.send(JSON.stringify({
                        type: 'delete_group',
                        groupId: currentChat.id
                    }));
                    
                    groups = groups.filter(g => g.id !== currentChat.id);
                    saveGroups();
                    
                    showScreen('contacts');
                    showNotification('–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞', 'info');
                }
            });
        }

        function leaveGroup() {
            if (!currentChat || !currentChat.id.startsWith('group_')) return;
            
            showConfirm('–ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É?', () => {
                if (socket) {
                    socket.send(JSON.stringify({
                        type: 'leave_group',
                        groupId: currentChat.id
                    }));
                    
                    const group = groups.find(g => g.id === currentChat.id);
                    if (group && group.members) {
                        group.members = group.members.filter(id => id !== currentUser.id);
                        if (group.members.length === 0) {
                            groups = groups.filter(g => g.id !== currentChat.id);
                        }
                        saveGroups();
                    }
                    
                    showScreen('contacts');
                    showNotification('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –≥—Ä—É–ø–ø—É', 'info');
                }
            });
        }

        // ========== –ú–ï–ù–Æ –ß–ê–¢–ê ==========
        function updateChatMenu() {
            if (!currentChat) { chatMenu.style.display = 'none'; return; }
            
            let menuHtml = '';
            
            if (currentChat.id === CHANNEL_ID) {
                if (currentUser && currentUser.id === ADMIN_ID) {
                    menuHtml += `<div class="chat-menu-item" onclick="clearChannel()"><span>üßπ</span> –û—á–∏—Å—Ç–∏—Ç—å –∫–∞–Ω–∞–ª</div>`;
                }
            } else if (currentChat.id.startsWith('group_')) {
                const group = groups.find(g => g.id === currentChat.id);
                if (group) {
                    menuHtml += `<div class="chat-menu-item" onclick="showGroupMembers()"><span>üë•</span> –£—á–∞—Å—Ç–Ω–∏–∫–∏ (${group.members?.length || 1})</div>`;
                    menuHtml += `<div class="chat-menu-item" onclick="showPollModal()"><span>üìä</span> –°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å</div>`;
                    if (currentUser.id === group.createdBy) {
                        menuHtml += `<div class="chat-menu-item" onclick="addToGroup()"><span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>`;
                        menuHtml += `<div class="chat-menu-item danger" onclick="deleteGroup()"><span>üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É</div>`;
                    } else {
                        menuHtml += `<div class="chat-menu-item warning" onclick="leaveGroup()"><span>üö™</span> –ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É</div>`;
                    }
                    menuHtml += `<div class="chat-menu-item" onclick="clearChat('${currentChat.id}')"><span>üßπ</span> –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</div>`;
                }
            } else {
                const isBlocked = blockedUsers.includes(currentChat.id);
                const isPinned = pinnedContacts.includes(currentChat.id);
                
                if (!isPinned) {
                    menuHtml += `<div class="chat-menu-item" onclick="pinContact('${currentChat.id}')"><span>üìå</span> –ó–∞–∫—Ä–µ–ø–∏—Ç—å</div>`;
                } else {
                    menuHtml += `<div class="chat-menu-item" onclick="unpinContact('${currentChat.id}')"><span>üìå</span> –û—Ç–∫—Ä–µ–ø–∏—Ç—å</div>`;
                }
                
                menuHtml += `<div class="chat-menu-item" onclick="clearChat('${currentChat.id}')"><span>üßπ</span> –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</div>`;
                menuHtml += `<div class="chat-menu-item" onclick="showConfirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤?', () => deleteContact('${currentChat.id}'))"><span>üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</div>`;
                
                if (isBlocked) {
                    menuHtml += `<div class="chat-menu-item" onclick="unblockContact('${currentChat.id}')"><span>üîì</span> –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</div>`;
                } else {
                    menuHtml += `<div class="chat-menu-item" onclick="blockContact('${currentChat.id}')"><span>üîí</span> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</div>`;
                }
            }
            
            chatMenu.innerHTML = menuHtml;
        }

        chatMenuBtn.onclick = (e) => {
            e.stopPropagation();
            updateChatMenu();
            chatMenu.classList.toggle('active');
        };

        document.addEventListener('click', () => chatMenu.classList.remove('active'));

        // ========== –ö–ê–ù–ê–õ ==========
        function openChannel() {
            currentChat = { 
                id: CHANNEL_ID, 
                name: 'Clock Messenger', 
                type: 'channel', 
                verified: true,
                isChannel: true 
            };
            
            chatName.innerHTML = 'Clock Messenger <span class="verified-badge">‚úÖ</span>';
            
            chatStatus.innerHTML = `${channelStats.subscribers} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ ‚Ä¢ ${channelStats.views} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤`;
            
            if (!messages[CHANNEL_ID]) {
                messages[CHANNEL_ID] = [];
            }
            
            renderMessages();
            updatePinnedBar();
            
            channelStats.views++;
            
            if (currentUser && currentUser.id === ADMIN_ID) {
                chatInput.disabled = false;
                sendMessageBtn.disabled = false;
                chatInput.placeholder = "–ù–∞–ø–∏—Å–∞—Ç—å –≤ –∫–∞–Ω–∞–ª...";
            } else {
                chatInput.disabled = true;
                sendMessageBtn.disabled = true;
                chatInput.placeholder = "–¢–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è";
            }
            
            if (socket) {
                socket.send(JSON.stringify({ type: 'channel_view' }));
            }
            
            showScreen('chats');
        }

        // ========== –ß–ê–¢ ==========
        function openChat(contact) {
            if (blockedUsers.includes(contact.id) && contact.id !== currentUser.id) {
                showNotification('–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'warning');
                return;
            }
            
            if (contact.id === CHANNEL_ID) { 
                openChannel(); 
                return; 
            }
            
            currentChat = contact;
            chatName.textContent = contact.name || contact.username;
            
            if (contact.id.startsWith('group_')) {
                const group = groups.find(g => g.id === contact.id);
                chatStatus.textContent = `${group?.members?.length || 1} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
            } else {
                chatStatus.textContent = contact.status === 'online' ? '–≤ —Å–µ—Ç–∏' : '–Ω–µ –≤ —Å–µ—Ç–∏';
            }
            
            if (!messages[contact.id]) {
                messages[contact.id] = [];
            }
            
            renderMessages();
            updatePinnedBar();
            
            chatInput.disabled = false;
            sendMessageBtn.disabled = false;
            chatInput.placeholder = "–°–æ–æ–±—â–µ–Ω–∏–µ...";
            
            showScreen('chats');
        }

        function renderMessages() {
            if (!currentChat) return;
            
            chatMessages.innerHTML = '';
            const chatMessagesList = messages[currentChat.id] || [];
            
            chatMessagesList.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${msg.from === currentUser.id ? 'message-mine' : 'message-other'}`;
                
                if (pinnedMessages[currentChat.id]?.find(m => m.id === msg.id)) {
                    msgDiv.classList.add('pinned');
                }
                if (msg.edited) {
                    msgDiv.classList.add('edited');
                }
                
                msgDiv.onclick = (e) => {
                    e.stopPropagation();
                    const rect = e.currentTarget.getBoundingClientRect();
                    showMessageOptions(msg, rect.left + rect.width/2, rect.top);
                };
                
                msgDiv.oncontextmenu = (e) => {
                    e.preventDefault();
                    const rect = e.currentTarget.getBoundingClientRect();
                    showMessageOptions(msg, rect.left + rect.width/2, rect.top);
                };
                
                let content = '';
                if (msg.fileData) {
                    if (msg.fileType?.startsWith('image/')) {
                        content = `<img src="${msg.fileData}" class="file-preview" onclick="window.open('${msg.fileData}')">`;
                    } else {
                        content = `<div class="file-message" onclick="window.open('${msg.fileData}')"><span class="file-icon">üìé</span><div><div>${msg.fileName || '–§–∞–π–ª'}</div><div class="file-name">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è</div></div></div>`;
                    }
                } else {
                    content = msg.text;
                }
                
                let senderHtml = '';
                if (currentChat.id.startsWith('group_') && msg.from !== currentUser.id) {
                    const sender = contacts.find(c => c.id === msg.from) || { name: msg.from };
                    senderHtml = `<div class="message-sender">${sender.name || msg.from}</div>`;
                }
                
                let replyHtml = '';
                if (msg.replyTo) {
                    const repliedMsg = chatMessagesList.find(m => m.id === msg.replyTo);
                    if (repliedMsg) {
                        replyHtml = `<div class="message-sender">‚Ü©Ô∏è –≤ –æ—Ç–≤–µ—Ç –Ω–∞: ${repliedMsg.text?.substring(0, 30)}${repliedMsg.text?.length > 30 ? '...' : ''}</div>`;
                    }
                }
                
                let reactionsHtml = '';
                if (msg.reactions) {
                    const reactionEntries = Object.entries(msg.reactions).filter(([key]) => key !== 'users');
                    if (reactionEntries.length > 0) {
                        reactionsHtml = '<div class="message-reactions">';
                        for (const [react, count] of reactionEntries) {
                            const hasUser = msg.reactions.users?.[react]?.includes(currentUser.id);
                            reactionsHtml += `
                                <span class="reaction ${hasUser ? 'selected' : ''}" onclick="event.stopPropagation(); addReactionToSelectedFromMsg('${msg.id}', '${react}')">
                                    ${react} <span class="reaction-count">${count}</span>
                                    <span class="reaction-users-popup">
                                        ${(msg.reactions.users?.[react] || []).map(id => {
                                            const user = contacts.find(c => c.id === id);
                                            return user?.name || id;
                                        }).join(', ')}
                                    </span>
                                </span>
                            `;
                        }
                        reactionsHtml += '</div>';
                    }
                }
                
                let timerHtml = '';
                if (msg.selfDestruct && msg.selfDestructTime) {
                    const timeLeft = Math.max(0, msg.selfDestructTime - (Date.now() - new Date(msg.timestamp).getTime()) / 1000);
                    if (timeLeft > 0) {
                        timerHtml = `<span class="self-destruct-timer">‚è±Ô∏è ${Math.round(timeLeft)}—Å</span>`;
                    }
                }
                
                msgDiv.innerHTML = `
                    ${replyHtml}
                    ${senderHtml}
                    <div>${content}</div>
                    <div class="message-time">
                        ${formatTime(msg.timestamp)}
                        ${timerHtml}
                        ${msg.edited ? ' <span class="message-status">–æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ</span>' : ''}
                        ${msg.from === currentUser.id ? ' ‚úì‚úì' : ''}
                    </div>
                    ${reactionsHtml}
                `;
                chatMessages.appendChild(msgDiv);
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addMessage(from, to, text, timestamp, fileData = null, fileName = null, fileType = null, replyTo = null, selfDestruct = false, selfDestructTime = 0) {
            if (blockedUsers.includes(from) && from !== currentUser.id) return;
            if (!messages[to]) messages[to] = [];
            
            const message = { 
                id: 'msg_' + Date.now() + Math.random(), 
                from, 
                text, 
                timestamp: timestamp || new Date().toISOString(), 
                reactions: { users: {} },
                read: false,
                replyTo: replyTo,
                selfDestruct: selfDestruct,
                selfDestructTime: selfDestructTime
            };
            
            if (fileData) { 
                message.fileData = fileData; 
                message.fileName = fileName; 
                message.fileType = fileType; 
            }
            
            messages[to].push(message);
            saveMessages();
            
            if (currentChat && (currentChat.id === to)) {
                renderMessages();
            }
            
            if (selfDestruct) {
                setTimeout(() => {
                    messages[to] = messages[to].filter(m => m.id !== message.id);
                    saveMessages();
                    if (currentChat && currentChat.id === to) {
                        renderMessages();
                    }
                }, selfDestructTime * 1000);
            }
            
            if (from === CHANNEL_ID || from === 'channel') {
                addNotification({ 
                    from: 'Clock Messenger', 
                    text: text || 'üìé –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª–µ', 
                    timestamp: message.timestamp, 
                    chatId: CHANNEL_ID 
                });
            } else if (from !== currentUser?.id && !blockedUsers.includes(from) && !to.startsWith('group_')) {
                const sender = contacts.find(c => c.id === from) || { name: from };
                addNotification({ from: sender.name || from, text: text || 'üìé –§–∞–π–ª', timestamp: message.timestamp, chatId: to });
            }
        }

        // ========== –û–ü–†–û–°–´ ==========
        function showPollModal() {
            if (!currentChat || !currentChat.id.startsWith('group_')) {
                showNotification('–û–ø—Ä–æ—Å—ã –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö', 'error');
                return;
            }
            
            pollOptions = 2;
            document.getElementById('pollOptions').innerHTML = `
                <input type="text" class="modal-input poll-option" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1">
                <input type="text" class="modal-input poll-option" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 2">
            `;
            createPollModal.classList.add('active');
        }

        function addPollOption() {
            pollOptions++;
            const optionsDiv = document.getElementById('pollOptions');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'modal-input poll-option';
            input.placeholder = `–í–∞—Ä–∏–∞–Ω—Ç ${pollOptions}`;
            optionsDiv.appendChild(input);
        }

        function closePollModal() {
            createPollModal.classList.remove('active');
        }

        function createPoll() {
            const question = pollQuestion.value.trim();
            if (!question) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å', 'error');
                return;
            }
            
            const options = [];
            document.querySelectorAll('.poll-option').forEach(input => {
                if (input.value.trim()) {
                    options.push(input.value.trim());
                }
            });
            
            if (options.length < 2) {
                showNotification('–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞', 'error');
                return;
            }
            
            if (socket) {
                socket.send(JSON.stringify({
                    type: 'create_poll',
                    pollGroupId: currentChat.id,
                    question: question,
                    options: options,
                    multiple: pollMultiple.checked
                }));
            }
            
            closePollModal();
            pollQuestion.value = '';
            showNotification('–û–ø—Ä–æ—Å —Å–æ–∑–¥–∞–Ω', 'success');
        }

        // ========== –ü–û–ò–°–ö ==========
        function showSearch() {
            const fromSelect = document.getElementById('searchFrom');
            fromSelect.innerHTML = '<option value="">–í—Å–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏</option>';
            
            contacts.forEach(contact => {
                const option = document.createElement('option');
                option.value = contact.id;
                option.textContent = contact.name || contact.username;
                fromSelect.appendChild(option);
            });
            
            searchModal.classList.add('active');
        }

        function closeSearchModal() {
            searchModal.classList.remove('active');
        }

        function searchMessages() {
            if (!socket) return;
            
            socket.send(JSON.stringify({
                type: 'search_messages',
                searchQuery: searchQuery.value,
                searchFrom: searchFrom.value,
                searchDate: searchDate.value
            }));
            
            closeSearchModal();
        }

        // ========== –°–ê–ú–û–£–ù–ò–ß–¢–û–ñ–ï–ù–ò–ï ==========
        function toggleSelfDestruct() {
            selfDestructModal.classList.toggle('active');
        }

        function setSelfDestruct(seconds) {
            selfDestructTime = seconds;
            if (seconds > 0) {
                selfDestructBtn.classList.add('active');
                showNotification(`–°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∏—Å—á–µ–∑–∞—Ç—å —á–µ—Ä–µ–∑ ${seconds} —Å–µ–∫—É–Ω–¥`, 'info');
            } else {
                selfDestructBtn.classList.remove('active');
            }
            selfDestructModal.classList.remove('active');
        }

        // ========== –ù–ê–í–ò–ì–ê–¶–ò–Ø ==========
        function showScreen(screenName) {
            authScreen.classList.remove('active');
            contactsScreen.classList.remove('active');
            chatsScreen.classList.remove('active');
            profileScreen.classList.remove('active');
            savedScreen.classList.remove('active');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            switch(screenName) {
                case 'auth': 
                    authScreen.classList.add('active'); 
                    break;
                case 'contacts': 
                    contactsScreen.classList.add('active'); 
                    document.querySelector('[data-tab="contacts"]').classList.add('active'); 
                    break;
                case 'chats': 
                    chatsScreen.classList.add('active'); 
                    document.querySelector('[data-tab="chats"]').classList.add('active'); 
                    break;
                case 'profile': 
                    profileScreen.classList.add('active'); 
                    document.querySelector('[data-tab="profile"]').classList.add('active'); 
                    break;
                case 'saved':
                    savedScreen.classList.add('active');
                    break;
            }
            currentTab = screenName;
        }

        // ========== API ==========
        async function login(email, password) {
            try {
                const res = await fetch('/api/login', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ login: email, password }) 
                });
                const data = await res.json();
                if (data.success) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    currentUser = data.user;
                    saveCurrentUser();
                    updateUIForUser();
                    connectWebSocket();
                    showNotification('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
                } else {
                    showNotification(data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', 'error');
                }
            } catch (e) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        async function register(email, username, password, name, bio) {
            try {
                const res = await fetch('/api/register', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ email, username, password, name, bio }) 
                });
                const data = await res.json();
                if (data.success) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    currentUser = data.user;
                    saveCurrentUser();
                    updateUIForUser();
                    connectWebSocket();
                    showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞', 'success');
                } else {
                    showNotification(data.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'error');
                }
            } catch (e) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // ========== WEB SOCKET ==========
        function connectWebSocket() {
            const wsUrl = `wss://${window.location.host}`;
            socket = new WebSocket(wsUrl);
            
            socket.onopen = () => {
                console.log('WebSocket –æ—Ç–∫—Ä—ã—Ç');
                statusEl.className = 'status-connected';
                statusEl.innerHTML = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                if (token) {
                    socket.send(JSON.stringify({ type: 'auth', token }));
                }
            };
            
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ:', data.type);
                
                switch(data.type) {
                    case 'auth_success':
                        console.log('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
                        currentUser = { ...currentUser, ...data.user };
                        contacts = data.contacts || [];
                        blockedUsers = data.blocked || [];
                        pinnedContacts = data.pinnedContacts || [];
                        groups = data.groups || [];
                        
                        saveContacts();
                        saveCurrentUser();
                        updateContacts();
                        showScreen('contacts');
                        break;
                        
                    case 'friends_list':
                        console.log('üìã –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π:', data.friends);
                        contacts = data.friends || [];
                        saveContacts();
                        updateContacts();
                        break;
                        
                    case 'blocked_list':
                        blockedUsers = data.blocked || [];
                        localStorage.setItem('blockedUsers', JSON.stringify(blockedUsers));
                        updateContacts();
                        break;
                        
                    case 'pinned_contacts':
                        pinnedContacts = data.pinned || [];
                        localStorage.setItem('pinnedContacts', JSON.stringify(pinnedContacts));
                        updateContacts();
                        break;
                        
                    case 'friend_request':
                        console.log('üîî –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç:', data.from);
                        showFriendRequestNotification({ 
                            from: data.from, 
                            fromName: data.fromName || data.from 
                        });
                        break;
                        
                    case 'friend_request_sent':
                        showNotification(`–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ${data.to}`, 'success');
                        break;
                        
                    case 'friend_request_accepted':
                        showNotification(data.message, 'success');
                        break;
                        
                    case 'message':
                        console.log('üí¨ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç:', data.from);
                        addMessage(data.from, data.from, data.text, data.timestamp, null, null, null, data.replyTo, data.selfDestruct, data.selfDestructTime);
                        break;
                        
                    case 'file_message':
                        console.log('üìé –ù–æ–≤—ã–π —Ñ–∞–π–ª –æ—Ç:', data.from);
                        addMessage(data.from, data.from, '', data.timestamp, data.fileData, data.fileName, data.fileType);
                        break;
                        
                    case 'channel_message':
                        console.log('üì¢ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª–µ');
                        if (currentUser) {
                            addMessage(CHANNEL_ID, CHANNEL_ID, data.content, data.timestamp, data.fileData, data.fileName, data.fileType);
                        }
                        break;
                        
                    case 'channel_stats':
                        channelStats = { subscribers: data.subscribers, views: data.views };
                        if (currentChat && currentChat.id === CHANNEL_ID) {
                            chatStatus.innerHTML = `${channelStats.subscribers} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ ‚Ä¢ ${channelStats.views} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤`;
                        }
                        break;
                        
                    case 'chat_cleared':
                        console.log('üßπ –ß–∞—Ç –æ—á–∏—â–µ–Ω:', data.chatId);
                        if (messages[data.chatId]) {
                            messages[data.chatId] = [];
                            saveMessages();
                            if (currentChat && currentChat.id === data.chatId) {
                                renderMessages();
                            }
                        }
                        showNotification('–ß–∞—Ç –±—ã–ª –æ—á–∏—â–µ–Ω', 'info');
                        break;
                        
                    case 'channel_cleared':
                        console.log('üßπ –ö–∞–Ω–∞–ª –æ—á–∏—â–µ–Ω');
                        if (messages[CHANNEL_ID]) {
                            messages[CHANNEL_ID] = [];
                            saveMessages();
                            if (currentChat && currentChat.id === CHANNEL_ID) {
                                renderMessages();
                            }
                        }
                        showNotification('–ö–∞–Ω–∞–ª –±—ã–ª –æ—á–∏—â–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º', 'warning');
                        break;
                        
                    case 'group_created':
                        if (data.group) {
                            const exists = groups.some(g => g.id === data.group.id);
                            if (!exists) {
                                groups.push(data.group);
                                saveGroups();
                                if (data.group.members?.includes(currentUser?.id)) {
                                    updateContacts();
                                    showNotification(`–ì—Ä—É–ø–ø–∞ "${data.group.name}" —Å–æ–∑–¥–∞–Ω–∞`, 'success');
                                }
                            }
                        }
                        break;
                        
                    case 'group_members_updated':
                        if (data.groupId) {
                            const group = groups.find(g => g.id === data.groupId);
                            if (group) {
                                chatStatus.textContent = `${data.count} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
                            }
                        }
                        break;
                        
                    case 'new_poll':
                        showNotification(`–ù–æ–≤—ã–π –æ–ø—Ä–æ—Å: ${data.question}`, 'info');
                        break;
                        
                    case 'search_results':
                        if (data.messages && data.messages.length > 0) {
                            let results = '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:\n';
                            data.messages.forEach(msg => {
                                results += `\n${msg.from_name}: ${msg.text}`;
                            });
                            showNotification(results, 'info');
                        } else {
                            showNotification('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'info');
                        }
                        break;
                        
                    case 'member_kicked':
                        if (data.groupId && data.memberId === currentUser?.id) {
                            groups = groups.filter(g => g.id !== data.groupId);
                            saveGroups();
                            updateContacts();
                            if (currentChat && currentChat.id === data.groupId) {
                                showScreen('contacts');
                            }
                            showNotification('–í–∞—Å –∏—Å–∫–ª—é—á–∏–ª–∏ –∏–∑ –≥—Ä—É–ø–ø—ã', 'warning');
                        } else if (data.groupId) {
                            const group = groups.find(g => g.id === data.groupId);
                            if (group && group.members) {
                                group.members = group.members.filter(id => id !== data.memberId);
                                saveGroups();
                                if (currentChat && currentChat.id === data.groupId) {
                                    chatStatus.textContent = `${group.members.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
                                }
                            }
                        }
                        break;
                        
                    case 'group_deleted':
                        groups = groups.filter(g => g.id !== data.groupId);
                        saveGroups();
                        updateContacts();
                        if (currentChat && currentChat.id === data.groupId) {
                            showScreen('contacts');
                        }
                        showNotification('–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞', 'info');
                        break;
                        
                    case 'pin_message':
                        if (data.chatId && data.message) {
                            if (!pinnedMessages[data.chatId]) {
                                pinnedMessages[data.chatId] = [];
                            }
                            if (!pinnedMessages[data.chatId].find(m => m.id === data.message.id)) {
                                pinnedMessages[data.chatId].push(data.message);
                                localStorage.setItem('pinnedMessages', JSON.stringify(pinnedMessages));
                                if (currentChat && currentChat.id === data.chatId) {
                                    updatePinnedBar();
                                }
                            }
                        }
                        break;
                        
                    case 'unpin_message':
                        if (data.chatId && pinnedMessages[data.chatId]) {
                            pinnedMessages[data.chatId].shift();
                            localStorage.setItem('pinnedMessages', JSON.stringify(pinnedMessages));
                            if (currentChat && currentChat.id === data.chatId) {
                                updatePinnedBar();
                            }
                        }
                        break;
                        
                    case 'edit_message':
                        if (data.chatId && messages[data.chatId]) {
                            const msg = messages[data.chatId].find(m => m.id === data.messageId);
                            if (msg) {
                                msg.text = data.text;
                                msg.edited = true;
                                saveMessages();
                                if (currentChat && currentChat.id === data.chatId) {
                                    renderMessages();
                                }
                            }
                        }
                        break;
                        
                    case 'delete_message':
                        if (data.chatId && messages[data.chatId]) {
                            messages[data.chatId] = messages[data.chatId].filter(m => m.id !== data.messageId);
                            saveMessages();
                            if (currentChat && currentChat.id === data.chatId) {
                                renderMessages();
                            }
                        }
                        break;
                        
                    case 'typing':
                        if (data.chatId === currentChat?.id) {
                            showTyping(data.userId);
                        }
                        break;
                        
                    case 'message_read':
                        if (data.chatId && messages[data.chatId]) {
                            const msg = messages[data.chatId].find(m => m.id === data.messageId);
                            if (msg) {
                                msg.read = true;
                                if (currentChat && currentChat.id === data.chatId) {
                                    renderMessages();
                                }
                            }
                        }
                        break;
                        
                    case 'reaction':
                        if (data.chatId && messages[data.chatId]) {
                            const msg = messages[data.chatId].find(m => m.id === data.messageId);
                            if (msg) {
                                if (!msg.reactions) msg.reactions = { users: {} };
                                if (!msg.reactions.users) msg.reactions.users = {};
                                
                                if (data.remove) {
                                    if (msg.reactions[data.reaction]) {
                                        msg.reactions[data.reaction]--;
                                        msg.reactions.users[data.reaction] = (msg.reactions.users[data.reaction] || []).filter(id => id !== data.userId);
                                        if (msg.reactions[data.reaction] <= 0) {
                                            delete msg.reactions[data.reaction];
                                            delete msg.reactions.users[data.reaction];
                                        }
                                    }
                                } else {
                                    for (let r in msg.reactions.users) {
                                        if (msg.reactions.users[r]?.includes(data.userId)) {
                                            msg.reactions[r]--;
                                            msg.reactions.users[r] = msg.reactions.users[r].filter(id => id !== data.userId);
                                            if (msg.reactions[r] <= 0) {
                                                delete msg.reactions[r];
                                                delete msg.reactions.users[r];
                                            }
                                        }
                                    }
                                    
                                    msg.reactions[data.reaction] = (msg.reactions[data.reaction] || 0) + 1;
                                    if (!msg.reactions.users[data.reaction]) msg.reactions.users[data.reaction] = [];
                                    msg.reactions.users[data.reaction].push(data.userId);
                                }
                                
                                if (currentChat && currentChat.id === data.chatId) {
                                    renderMessages();
                                }
                            }
                        }
                        break;
                        
                    case 'new_story':
                        stories.push(data);
                        break;
                        
                    case 'error':
                        showNotification(data.message, 'error');
                        break;
                        
                    default:
                        console.log('‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø:', data.type);
                }
            };
            
            socket.onclose = () => {
                console.log('WebSocket –∑–∞–∫—Ä—ã—Ç');
                statusEl.className = 'status-disconnected';
                statusEl.innerHTML = 'üî¥ –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
                setTimeout(connectWebSocket, 3000);
            };
            
            socket.onerror = (error) => {
                console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
            };
        }

        // ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ==========
        function updateUIForUser() {
            if (currentUser) {
                authButton.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userName.textContent = currentUser.name || currentUser.username;
                userAvatar.textContent = getInitials(currentUser.name || currentUser.username);
                profileName.textContent = currentUser.name || currentUser.username;
                profileUsername.textContent = '@' + currentUser.username;
                profileBio.textContent = currentUser.bio || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
                profileAvatar.textContent = getInitials(currentUser.name || currentUser.username);
            } else {
                authButton.classList.remove('hidden');
                userInfo.classList.add('hidden');
            }
            updateContacts();
            updateSavedCount();
        }

        function updateContacts() {
            const searchTerm = searchContacts?.value?.toLowerCase() || '';
            contactsList.innerHTML = '';
            
            if (!currentUser) return;
            
            // –ö–∞–Ω–∞–ª
            const channelEl = document.createElement('div');
            channelEl.className = 'contact-item';
            channelEl.innerHTML = `
                <div class="contact-avatar" style="background: var(--primary);">üì¢</div>
                <div class="contact-info">
                    <div class="contact-name">
                        Clock Messenger 
                        <span class="verified-badge">‚úÖ</span>
                        ${currentUser.id === ADMIN_ID ? '<span class="admin-badge">–∞–¥–º–∏–Ω</span>' : ''}
                    </div>
                    <div class="contact-status">${channelStats.subscribers} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</div>
                </div>
            `;
            channelEl.onclick = openChannel;
            contactsList.appendChild(channelEl);
            
            // –ì—Ä—É–ø–ø—ã
            const userGroups = groups.filter(group => group.members?.includes(currentUser.id));
            
            userGroups.forEach(group => {
                if (group.name.toLowerCase().includes(searchTerm)) {
                    const groupEl = document.createElement('div');
                    groupEl.className = 'contact-item';
                    groupEl.innerHTML = `
                        <div class="contact-avatar" style="background: var(--secondary);">üë•</div>
                        <div class="contact-info">
                            <div class="contact-name">${group.name} <span class="group-badge">–≥—Ä—É–ø–ø–∞</span></div>
                            <div class="contact-status">${group.members?.length || 1} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                        </div>
                    `;
                    groupEl.onclick = () => openChat(group);
                    contactsList.appendChild(groupEl);
                }
            });
            
            // –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
            const pinned = contacts.filter(c => pinnedContacts.includes(c.id));
            if (pinned.length > 0) {
                const pinnedSection = document.createElement('div');
                pinnedSection.className = 'contacts-section';
                pinnedSection.innerHTML = '<div class="section-title">üìå –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ</div>';
                
                pinned.forEach(contact => {
                    const isBlocked = blockedUsers.includes(contact.id);
                    const el = document.createElement('div');
                    el.className = 'contact-item pinned';
                    el.innerHTML = `
                        <div class="contact-avatar">${getInitials(contact.name || contact.username)}</div>
                        <div class="contact-info">
                            <div class="contact-name">${contact.name || contact.username}${isBlocked ? ' <span class="blocked-badge">–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>' : ''}</div>
                            <div class="contact-status">${contact.status === 'online' ? 'üü¢ –≤ —Å–µ—Ç–∏' : '‚ö´ –Ω–µ –≤ —Å–µ—Ç–∏'}</div>
                            <div class="contact-last-seen">${formatLastSeen(contact.lastSeen)}</div>
                        </div>
                    `;
                    el.onclick = () => openChat(contact);
                    pinnedSection.appendChild(el);
                });
                
                contactsList.appendChild(pinnedSection);
            }
            
            // –û–±—ã—á–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
            const regular = contacts.filter(c => !pinnedContacts.includes(c.id));
            const filtered = regular.filter(c => 
                (c.name || '').toLowerCase().includes(searchTerm) || 
                (c.username || '').toLowerCase().includes(searchTerm)
            );
            
            if (filtered.length > 0) {
                const regularSection = document.createElement('div');
                regularSection.className = 'contacts-section';
                regularSection.innerHTML = '<div class="section-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>';
                
                filtered.forEach(contact => {
                    const isBlocked = blockedUsers.includes(contact.id);
                    const el = document.createElement('div');
                    el.className = 'contact-item';
                    el.innerHTML = `
                        <div class="contact-avatar">${getInitials(contact.name || contact.username)}</div>
                        <div class="contact-info">
                            <div class="contact-name">${contact.name || contact.username}${isBlocked ? ' <span class="blocked-badge">–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>' : ''}</div>
                            <div class="contact-status">${contact.status === 'online' ? 'üü¢ –≤ —Å–µ—Ç–∏' : '‚ö´ –Ω–µ –≤ —Å–µ—Ç–∏'}</div>
                            <div class="contact-last-seen">${formatLastSeen(contact.lastSeen)}</div>
                        </div>
                    `;
                    el.onclick = () => openChat(contact);
                    regularSection.appendChild(el);
                });
                
                contactsList.appendChild(regularSection);
            }
            
            contactsCount.textContent = contacts.length;
        }

        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========
        authButton.onclick = () => showScreen('auth');
        
        loginTab.onclick = () => {
            loginTab.classList.add('active');
            registerTab.classList.remove('active');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
        };
        
        registerTab.onclick = () => {
            registerTab.classList.add('active');
            loginTab.classList.remove('active');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
        };
        
        loginSubmit.onclick = () => login(loginEmail.value, loginPassword.value);
        
        registerSubmit.onclick = () => register(
            registerEmail.value, 
            registerUsername.value, 
            registerPassword.value, 
            registerName.value, 
            registerBio.value
        );
        
        addFriendCancel.onclick = () => {
            addFriendModal.classList.remove('active');
            addFriendInput.value = '';
        };
        
        addFriendConfirm.onclick = () => {
            if (socket && addFriendInput.value) {
                socket.send(JSON.stringify({ 
                    type: 'add_friend', 
                    friendId: addFriendInput.value 
                }));
                addFriendModal.classList.remove('active');
                addFriendInput.value = '';
                showNotification('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
            }
        };
        
        createGroupCancel.onclick = () => {
            createGroupModal.classList.remove('active');
            groupName.value = '';
            groupDescription.value = '';
        };
        
        createGroupConfirm.onclick = () => {
            const name = groupName.value.trim();
            if (!name) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã', 'error');
                return;
            }
            
            if (socket) {
                const groupId = 'group_' + Date.now();
                const newGroup = {
                    id: groupId,
                    name: name,
                    description: groupDescription.value.trim(),
                    createdBy: currentUser.id,
                    members: [currentUser.id],
                    createdAt: new Date().toISOString()
                };
                
                socket.send(JSON.stringify({
                    type: 'create_group',
                    group: newGroup
                }));
                
                groups.push(newGroup);
                saveGroups();
                updateContacts();
                
                openChat(newGroup);
                
                createGroupModal.classList.remove('active');
                groupName.value = '';
                groupDescription.value = '';
                
                showNotification('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success');
            }
        };
        
        addToGroupCancel.onclick = () => {
            addToGroupModal.classList.remove('active');
            selectedContactsForGroup = [];
        };
        
        addToGroupConfirm.onclick = () => {
            if (socket && currentChat && selectedContactsForGroup.length > 0) {
                socket.send(JSON.stringify({
                    type: 'add_to_group',
                    groupId: currentChat.id,
                    members: selectedContactsForGroup
                }));
                
                const group = groups.find(g => g.id === currentChat.id);
                if (group) {
                    if (!group.members) group.members = [];
                    selectedContactsForGroup.forEach(memberId => {
                        if (!group.members.includes(memberId)) {
                            group.members.push(memberId);
                        }
                    });
                    saveGroups();
                    
                    if (currentChat && currentChat.id === group.id) {
                        chatStatus.textContent = `${group.members.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
                    }
                }
                
                addToGroupModal.classList.remove('active');
                selectedContactsForGroup = [];
                showNotification('–£—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã', 'success');
            }
        };
        
        groupMembersClose.onclick = () => {
            groupMembersModal.classList.remove('active');
        };
        
        editProfileBtn.onclick = () => {
            editName.value = currentUser.name || '';
            editBio.value = currentUser.bio || '';
            editProfileModal.classList.add('active');
        };
        
        editProfileCancel.onclick = () => editProfileModal.classList.remove('active');
        
        editProfileConfirm.onclick = () => {
            if (socket) {
                socket.send(JSON.stringify({ 
                    type: 'update_profile', 
                    name: editName.value, 
                    bio: editBio.value,
                    avatar: currentUser.avatar,
                    theme: theme,
                    accent_color: accentColor,
                    privacy_last_seen: privacySettings.lastSeen,
                    privacy_messages: privacySettings.messages,
                    privacy_groups: privacySettings.groups,
                    notification_sound: notificationSettings.sound,
                    notification_vibrate: notificationSettings.vibrate,
                    notification_preview: notificationSettings.preview,
                    invisible_mode: privacySettings.invisibleMode
                }));
                currentUser.name = editName.value;
                currentUser.bio = editBio.value;
                saveCurrentUser();
                updateUIForUser();
            }
            editProfileModal.classList.remove('active');
            showNotification('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
        };
        
        selfDestructBtn.onclick = toggleSelfDestruct;
        
        sendMessageBtn.onclick = () => {
            if (!socket || !currentChat || !chatInput.value) return;
            const text = chatInput.value.trim();
            if (!text) return;
            
            if (editingMessage) {
                socket.send(JSON.stringify({
                    type: 'edit_message',
                    chatId: currentChat.id,
                    messageId: editingMessage.id,
                    text: text
                }));
                cancelEdit();
            } else if (currentChat.id === CHANNEL_ID) {
                if (currentUser.id === ADMIN_ID) {
                    socket.send(JSON.stringify({ 
                        type: 'channel_message', 
                        content: text 
                    }));
                } else {
                    showNotification('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –≤ –∫–∞–Ω–∞–ª', 'error');
                    return;
                }
            } else {
                socket.send(JSON.stringify({ 
                    type: 'message', 
                    to: currentChat.id, 
                    text: text,
                    replyTo: replyingTo?.id || null,
                    selfDestruct: selfDestructTime > 0,
                    selfDestructTime: selfDestructTime
                }));
                
                addMessage(
                    currentUser.id, 
                    currentChat.id, 
                    text, 
                    new Date().toISOString(), 
                    null, null, null, 
                    replyingTo?.id || null,
                    selfDestructTime > 0,
                    selfDestructTime
                );
                
                if (replyingTo) cancelReply();
            }
            
            chatInput.value = '';
        };
        
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessageBtn.click();
            }
            sendTyping();
        });
        
        chatInput.addEventListener('input', () => {
            sendTyping();
        });
        
        searchContacts?.addEventListener('input', updateContacts);
        searchContactsForGroup?.addEventListener('input', renderContactsForGroup);
        searchForwardContacts?.addEventListener('input', renderForwardContacts);
        
        tabButtons.forEach(btn => {
            btn.onclick = () => showScreen(btn.dataset.tab);
        });

        document.addEventListener('click', (e) => {
            if (notificationPopup && !notificationPopup.contains(e.target) && e.target !== notificationBell) {
                notificationPopup.remove();
                notificationPopup = null;
            }
        });

        setInterval(() => {
            if (socket && currentUser) {
                socket.send(JSON.stringify({ type: 'get_channel_stats' }));
            }
        }, 30000);

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        applyTheme();
        updateSavedCount();
        
        if (token && currentUser) {
            connectWebSocket();
            showScreen('contacts');
            updateUIForUser();
        } else {
            showScreen('auth');
        }
    </script>
</body>
</html>



















