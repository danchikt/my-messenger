<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#8774e1">
    <link rel="manifest" href="/manifest.json">
    <title>Clock Messenger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        :root {
            --primary: #8774e1;
            --primary-dark: #6b5b9e;
            --secondary: #31c4b2;
            --bg: #f5f7fb;
            --surface: #ffffff;
            --text: #1c1e21;
            --text-secondary: #65676b;
            --border: #e4e6eb;
            --error: #f15b6f;
            --success: #31c4b2;
            --warning: #f39c12;
        }

        body {
            background: var(--bg);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
        }

        .app-container {
            width: 100%;
            max-width: 500px;
            height: 100vh;
            background: var(--surface);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }

        .status-bar {
            background: var(--surface);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-connected {
            color: var(--success);
            font-size: 14px;
            font-weight: 500;
        }

        .status-disconnected {
            color: var(--error);
            font-size: 14px;
            font-weight: 500;
        }

        .notification-badge {
            position: relative;
            cursor: pointer;
        }

        .bell-icon {
            font-size: 22px;
        }

        .bell-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--error);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .auth-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-button {
            background: var(--error);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 8px;
        }

        .logout-button:hover {
            opacity: 0.8;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: none;
            background: var(--bg);
        }

        .main-content.active {
            display: block;
        }

        .auth-screen, .contacts-screen, .chats-screen, .profile-screen {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .auth-form {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            border-bottom: 2px solid var(--border);
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .auth-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .auth-input {
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: var(--bg);
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-submit {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        .search-bar {
            background: var(--surface);
            border-radius: 20px;
            padding: 8px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .search-bar input {
            flex: 1;
            border: none;
            background: none;
            padding: 8px 0;
            font-size: 16px;
        }

        .search-bar input:focus {
            outline: none;
        }

        .contacts-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .contact-item {
            background: var(--surface);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .contact-item:hover {
            background: #f0f2f5;
        }

        .contact-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            flex-shrink: 0;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .contact-status {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .verified-badge {
            color: var(--primary);
            font-size: 14px;
        }

        .blocked-badge {
            color: var(--error);
            font-size: 12px;
            background: rgba(241, 91, 111, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }

        .group-badge {
            background: var(--secondary);
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            transition: transform 0.2s;
            cursor: pointer;
            user-select: none;
        }

        .message:active {
            transform: scale(0.98);
        }

        .message-mine {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-other {
            align-self: flex-start;
            background: var(--surface);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        .message-sender {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--primary);
        }

        .message-time {
            font-size: 10px;
            margin-top: 4px;
            opacity: 0.7;
            text-align: right;
        }

        .message-reactions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .reaction {
            background: rgba(0,0,0,0.05);
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .reaction:hover {
            background: rgba(0,0,0,0.1);
        }

        .reaction.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary-dark);
        }

        .reaction-picker {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            border-radius: 40px;
            padding: 12px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: none;
            gap: 16px;
            z-index: 1000;
            animation: slideUp 0.2s ease;
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .reaction-picker.active {
            display: flex;
        }

        .reaction-option {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            transition: transform 0.2s;
        }

        .reaction-option:hover {
            transform: scale(1.2);
            background: var(--primary);
            color: white;
        }

        .chat-input-area {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: var(--surface);
            border-top: 1px solid var(--border);
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 24px;
            font-size: 16px;
            background: var(--bg);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .chat-send {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .attach-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--surface);
            color: var(--primary);
            border: 1px solid var(--border);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-header {
            padding: 16px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-back {
            font-size: 24px;
            cursor: pointer;
            color: var(--primary);
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-name {
            font-weight: 600;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .chat-header-status {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .chat-header-actions {
            display: flex;
            gap: 8px;
            position: relative;
        }

        .chat-header-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--primary);
        }

        .chat-menu {
            position: absolute;
            top: 40px;
            right: 0;
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 200px;
            z-index: 100;
            display: none;
        }

        .chat-menu.active {
            display: block;
        }

        .chat-menu-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-menu-item:hover {
            background: #f0f2f5;
        }

        .chat-menu-item.danger {
            color: var(--error);
        }

        .chat-menu-item.warning {
            color: var(--warning);
        }

        .profile-header {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 40px;
            margin: 0 auto 16px;
            cursor: pointer;
            position: relative;
        }

        .avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .profile-avatar-large:hover .avatar-overlay {
            opacity: 1;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .profile-username {
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-size: 16px;
        }

        .profile-bio {
            color: var(--text);
            margin-bottom: 20px;
            font-size: 16px;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-weight: 600;
            font-size: 20px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .channel-stats {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .bottom-tabs {
            display: flex;
            justify-content: space-around;
            padding: 8px 16px;
            background: var(--surface);
            border-top: 1px solid var(--border);
        }

        .tab-button {
            background: none;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 20px;
            transition: all 0.2s;
        }

        .tab-button.active {
            background: var(--primary);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: 16px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-button {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-button-primary {
            background: var(--primary);
            color: white;
        }

        .modal-button-secondary {
            background: var(--border);
            color: var(--text);
        }

        .modal-button-danger {
            background: var(--error);
            color: white;
        }

        .members-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .member-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .member-item:last-child {
            border-bottom: none;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 600;
        }

        .member-role {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .remove-member {
            color: var(--error);
            cursor: pointer;
            padding: 8px;
        }

        .notification-container {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            width: 90%;
            max-width: 400px;
        }

        .notification {
            background: var(--surface);
            border-left: 4px solid var(--primary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--error);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        .notification-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .notification-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-accept {
            background: var(--success);
            color: white;
        }

        .btn-decline {
            background: var(--error);
            color: white;
        }

        .hidden {
            display: none !important;
        }

        .notifications-popup {
            position: fixed;
            top: 80px;
            right: 16px;
            background: var(--surface);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 101;
            min-width: 280px;
            max-width: 320px;
            max-height: 400px;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-item {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item:hover {
            background: #f0f2f5;
        }

        .notification-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .notification-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .notification-time {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .file-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
        }

        .file-message {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .file-icon {
            font-size: 24px;
        }

        .file-name {
            font-size: 12px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="status-bar">
            <div class="status-left">
                <div id="statusDisplay" class="status-disconnected">üî¥ –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
                <div class="notification-badge" id="notificationBell" style="display: none;">
                    <span class="bell-icon">üîî</span>
                    <span class="bell-count" id="notificationCount">0</span>
                </div>
            </div>
            <div id="authContainer">
                <button id="authButton" class="auth-button">–í–æ–π—Ç–∏</button>
                <div id="userInfo" class="user-info hidden">
                    <div id="userAvatar" class="user-avatar-small">?</div>
                    <span id="userName"></span>
                    <button id="logoutBtn" class="logout-button">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>

        <div id="authScreen" class="main-content">
            <div class="auth-screen">
                <div class="auth-form">
                    <div class="auth-tabs">
                        <button id="loginTab" class="auth-tab active">–í—Ö–æ–¥</button>
                        <button id="registerTab" class="auth-tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                    </div>
                    
                    <div id="loginForm">
                        <input type="text" id="loginEmail" class="auth-input" placeholder="Email –∏–ª–∏ username">
                        <input type="password" id="loginPassword" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
                        <button id="loginSubmit" class="auth-submit">–í–æ–π—Ç–∏</button>
                    </div>
                    
                    <div id="registerForm" class="hidden">
                        <input type="email" id="registerEmail" class="auth-input" placeholder="Email">
                        <input type="text" id="registerUsername" class="auth-input" placeholder="Username">
                        <input type="password" id="registerPassword" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
                        <input type="text" id="registerName" class="auth-input" placeholder="–ò–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                        <input type="text" id="registerBio" class="auth-input" placeholder="–û —Å–µ–±–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                        <button id="registerSubmit" class="auth-submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="contactsScreen" class="main-content">
            <div class="contacts-screen">
                <div class="search-bar">
                    <span>üîç</span>
                    <input type="text" id="searchContacts" placeholder="–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...">
                    <button id="addFriendBtn" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚ûï</button>
                    <button id="createGroupBtn" style="background: none; border: none; font-size: 20px; cursor: pointer;">üë•</button>
                </div>
                <div id="contactsList" class="contacts-list"></div>
            </div>
        </div>

        <div id="chatsScreen" class="main-content">
            <div class="chats-screen">
                <div class="chat-header">
                    <span class="chat-back" onclick="showScreen('contacts')">‚Üê</span>
                    <div class="chat-header-info">
                        <div class="chat-header-name" id="chatName">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                        <div class="chat-header-status" id="chatStatus"></div>
                    </div>
                    <div class="chat-header-actions">
                        <button class="chat-header-btn" id="chatMenuBtn">‚ãÆ</button>
                        <div class="chat-menu" id="chatMenu"></div>
                    </div>
                </div>
                <div id="chatMessages" class="chat-messages"></div>
                <div class="chat-input-area">
                    <button class="attach-btn" id="attachFileBtn">üìé</button>
                    <input type="text" id="chatInput" class="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                    <button id="sendMessageBtn" class="chat-send" disabled>‚û§</button>
                </div>
            </div>
        </div>

        <div id="profileScreen" class="main-content">
            <div class="profile-screen">
                <div class="profile-header">
                    <div class="profile-avatar-large" id="profileAvatar">?</div>
                    <div class="profile-name" id="profileName"></div>
                    <div class="profile-username" id="profileUsername"></div>
                    <div class="profile-bio" id="profileBio"></div>
                    <button id="editProfileBtn" class="auth-button">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="contactsCount">0</div>
                        <div class="stat-label">–∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="channelsCount">1</div>
                        <div class="stat-label">–∫–∞–Ω–∞–ª</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-tabs">
            <button class="tab-button active" data-tab="contacts">üë• –ö–æ–Ω—Ç–∞–∫—Ç—ã</button>
            <button class="tab-button" data-tab="chats">üí¨ –ß–∞—Ç—ã</button>
            <button class="tab-button" data-tab="profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ —Ä–µ–∞–∫—Ü–∏–π -->
    <div id="reactionPicker" class="reaction-picker">
        <span class="reaction-option" onclick="addReactionToSelected('üëç')">üëç</span>
        <span class="reaction-option" onclick="addReactionToSelected('‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span class="reaction-option" onclick="addReactionToSelected('üòÆ')">üòÆ</span>
        <span class="reaction-option" onclick="addReactionToSelected('üò¢')">üò¢</span>
        <span class="reaction-option" onclick="addReactionToSelected('üò°')">üò°</span>
        <span class="reaction-option" onclick="addReactionToSelected('üéâ')">üéâ</span>
    </div>

    <div id="addFriendModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</div>
            <input type="text" id="addFriendInput" class="modal-input" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ @username">
            <div class="modal-buttons">
                <button id="addFriendCancel" class="modal-button modal-button-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button id="addFriendConfirm" class="modal-button modal-button-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</div>
            <input type="text" id="groupName" class="modal-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
            <input type="text" id="groupDescription" class="modal-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            <div class="modal-buttons">
                <button id="createGroupCancel" class="modal-button modal-button-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button id="createGroupConfirm" class="modal-button modal-button-primary">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="addToGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
            <input type="text" id="searchContactsForGroup" class="modal-input" placeholder="–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...">
            <div id="contactsForGroupList" class="members-list"></div>
            <div class="modal-buttons">
                <button id="addToGroupCancel" class="modal-button modal-button-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button id="addToGroupConfirm" class="modal-button modal-button-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="groupMembersModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã</div>
            <div id="groupMembersList" class="members-list"></div>
            <div class="modal-buttons">
                <button id="groupMembersClose" class="modal-button modal-button-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>
            <input type="text" id="editName" class="modal-input" placeholder="–ò–º—è">
            <input type="text" id="editBio" class="modal-input" placeholder="–û —Å–µ–±–µ">
            <input type="file" id="editAvatarFile" accept="image/*" class="modal-input" style="padding: 8px;">
            <div class="modal-buttons">
                <button id="editProfileCancel" class="modal-button modal-button-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button id="editProfileConfirm" class="modal-button modal-button-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="confirmTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
            <p id="confirmMessage" style="margin-bottom: 20px;"></p>
            <div class="modal-buttons">
                <button id="confirmCancel" class="modal-button modal-button-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button id="confirmOk" class="modal-button modal-button-primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="notificationContainer" class="notification-container"></div>

    <script>
        // ========== –°–û–°–¢–û–Ø–ù–ò–ï ==========
        let token = localStorage.getItem('token');
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        let contacts = JSON.parse(localStorage.getItem('contacts')) || [];
        let messages = JSON.parse(localStorage.getItem('messages')) || {};
        let currentChat = null;
        let groups = JSON.parse(localStorage.getItem('groups')) || [];
        let socket = null;
        let currentTab = 'contacts';
        let pendingRequests = [];
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let channelStats = { subscribers: 1, views: 0 };
        let blockedUsers = JSON.parse(localStorage.getItem('blockedUsers')) || [];
        let selectedContactsForGroup = [];
        let selectedMessageId = null;

        // ========== DOM –≠–õ–ï–ú–ï–ù–¢–´ ==========
        const statusEl = document.getElementById('statusDisplay');
        const authButton = document.getElementById('authButton');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        
        const authScreen = document.getElementById('authScreen');
        const contactsScreen = document.getElementById('contactsScreen');
        const chatsScreen = document.getElementById('chatsScreen');
        const profileScreen = document.getElementById('profileScreen');
        
        const tabButtons = document.querySelectorAll('.tab-button');
        
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const loginSubmit = document.getElementById('loginSubmit');
        
        const registerEmail = document.getElementById('registerEmail');
        const registerUsername = document.getElementById('registerUsername');
        const registerPassword = document.getElementById('registerPassword');
        const registerName = document.getElementById('registerName');
        const registerBio = document.getElementById('registerBio');
        const registerSubmit = document.getElementById('registerSubmit');
        
        const contactsList = document.getElementById('contactsList');
        const searchContacts = document.getElementById('searchContacts');
        const addFriendBtn = document.getElementById('addFriendBtn');
        const createGroupBtn = document.getElementById('createGroupBtn');
        
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const attachFileBtn = document.getElementById('attachFileBtn');
        const chatName = document.getElementById('chatName');
        const chatStatus = document.getElementById('chatStatus');
        const chatMenuBtn = document.getElementById('chatMenuBtn');
        const chatMenu = document.getElementById('chatMenu');
        
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profileUsername = document.getElementById('profileUsername');
        const profileBio = document.getElementById('profileBio');
        const contactsCount = document.getElementById('contactsCount');
        const channelsCount = document.getElementById('channelsCount');
        const editProfileBtn = document.getElementById('editProfileBtn');
        
        const addFriendModal = document.getElementById('addFriendModal');
        const addFriendInput = document.getElementById('addFriendInput');
        const addFriendConfirm = document.getElementById('addFriendConfirm');
        const addFriendCancel = document.getElementById('addFriendCancel');
        
        const createGroupModal = document.getElementById('createGroupModal');
        const groupName = document.getElementById('groupName');
        const groupDescription = document.getElementById('groupDescription');
        const createGroupConfirm = document.getElementById('createGroupConfirm');
        const createGroupCancel = document.getElementById('createGroupCancel');
        
        const addToGroupModal = document.getElementById('addToGroupModal');
        const searchContactsForGroup = document.getElementById('searchContactsForGroup');
        const contactsForGroupList = document.getElementById('contactsForGroupList');
        const addToGroupConfirm = document.getElementById('addToGroupConfirm');
        const addToGroupCancel = document.getElementById('addToGroupCancel');
        
        const groupMembersModal = document.getElementById('groupMembersModal');
        const groupMembersList = document.getElementById('groupMembersList');
        const groupMembersClose = document.getElementById('groupMembersClose');
        
        const editProfileModal = document.getElementById('editProfileModal');
        const editName = document.getElementById('editName');
        const editBio = document.getElementById('editBio');
        const editAvatarFile = document.getElementById('editAvatarFile');
        const editProfileConfirm = document.getElementById('editProfileConfirm');
        const editProfileCancel = document.getElementById('editProfileCancel');
        
        const confirmModal = document.getElementById('confirmModal');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmOk = document.getElementById('confirmOk');
        
        const notificationBell = document.getElementById('notificationBell');
        const notificationCount = document.getElementById('notificationCount');
        const reactionPicker = document.getElementById('reactionPicker');
        let notificationPopup = null;

        // ========== –£–¢–ò–õ–ò–¢–´ ==========
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <span onclick="this.parentElement.parentElement.remove()" style="cursor: pointer;">‚úï</span>
                </div>
            `;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }

        function saveMessages() {
            localStorage.setItem('messages', JSON.stringify(messages));
        }

        function saveGroups() {
            localStorage.setItem('groups', JSON.stringify(groups));
        }

        function saveContacts() {
            localStorage.setItem('contacts', JSON.stringify(contacts));
        }

        function saveCurrentUser() {
            if (currentUser) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
        }

        function showConfirm(title, message, onConfirm) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmModal.classList.add('active');
            
            const originalOnClick = confirmOk.onclick;
            confirmOk.onclick = () => { 
                onConfirm(); 
                confirmModal.classList.remove('active');
                confirmOk.onclick = originalOnClick;
            };
            
            confirmCancel.onclick = () => {
                confirmModal.classList.remove('active');
            };
        }

        function logout() {
            showConfirm('–í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?', () => {
                if (socket) {
                    socket.close();
                    socket = null;
                }
                
                currentUser = null;
                token = null;
                localStorage.removeItem('token');
                localStorage.removeItem('currentUser');
                
                contacts = [];
                groups = [];
                messages = {};
                notifications = [];
                pendingRequests = [];
                blockedUsers = [];
                
                updateUIForUser();
                showScreen('auth');
                showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', 'info');
            });
        }

        logoutBtn.onclick = logout;

        // ========== –†–ï–ê–ö–¶–ò–ò ==========
        function showReactionPicker(messageId, x, y) {
            selectedMessageId = messageId;
            reactionPicker.classList.add('active');
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —Ä—è–¥–æ–º —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            reactionPicker.style.left = x + 'px';
            reactionPicker.style.top = (y - 60) + 'px';
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
            setTimeout(() => {
                document.addEventListener('click', closeReactionPicker);
            }, 100);
        }

        function closeReactionPicker(e) {
            if (!reactionPicker.contains(e.target)) {
                reactionPicker.classList.remove('active');
                document.removeEventListener('click', closeReactionPicker);
            }
        }

        function addReactionToSelected(reaction) {
            if (selectedMessageId && currentChat && socket) {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                socket.send(JSON.stringify({
                    type: 'reaction',
                    chatId: currentChat.id,
                    messageId: selectedMessageId,
                    reaction: reaction,
                    remove: false
                }));
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏—é –ª–æ–∫–∞–ª—å–Ω–æ
                const chatMessagesList = messages[currentChat.id] || [];
                const message = chatMessagesList.find(m => m.id === selectedMessageId);
                if (message) {
                    if (!message.reactions) message.reactions = {};
                    message.reactions[reaction] = (message.reactions[reaction] || 0) + 1;
                    renderMessages();
                }
                
                reactionPicker.classList.remove('active');
            }
        }

        function removeReaction(messageId, reaction) {
            if (currentChat && socket) {
                socket.send(JSON.stringify({
                    type: 'reaction',
                    chatId: currentChat.id,
                    messageId: messageId,
                    reaction: reaction,
                    remove: true
                }));
                
                const chatMessagesList = messages[currentChat.id] || [];
                const message = chatMessagesList.find(m => m.id === messageId);
                if (message && message.reactions && message.reactions[reaction]) {
                    message.reactions[reaction]--;
                    if (message.reactions[reaction] <= 0) {
                        delete message.reactions[reaction];
                    }
                    renderMessages();
                }
            }
        }

        // ========== –°–ò–°–¢–ï–ú–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ==========
        function addNotification(notification) {
            notifications.unshift(notification);
            if (notifications.length > 50) notifications.pop();
            localStorage.setItem('notifications', JSON.stringify(notifications));
            updateNotificationBell();
            showNotification(notification.text, 'info');
        }

        function updateNotificationBell() {
            if (notifications.length > 0) {
                notificationBell.style.display = 'block';
                notificationCount.textContent = notifications.length;
            } else {
                notificationBell.style.display = 'none';
            }
        }

        notificationBell.onclick = (e) => {
            e.stopPropagation();
            if (notificationPopup) {
                notificationPopup.remove();
                notificationPopup = null;
                return;
            }
            notificationPopup = document.createElement('div');
            notificationPopup.className = 'notifications-popup';
            let html = '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;"><h3 style="font-size: 16px;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3><span style="cursor: pointer; font-size: 18px;" onclick="this.parentElement.parentElement.remove(); notificationPopup = null;">‚úï</span></div>';
            if (notifications.length === 0) {
                html += '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>';
            } else {
                notifications.forEach(notif => {
                    html += `<div class="notification-item" onclick="openChatFromNotification('${notif.chatId}')"><div class="notification-avatar">${getInitials(notif.from)}</div><div class="notification-content"><div class="notification-title">${notif.from}</div><div class="notification-text">${notif.text}</div><div class="notification-time">${formatTime(notif.timestamp)}</div></div></div>`;
                });
            }
            notificationPopup.innerHTML = html;
            document.body.appendChild(notificationPopup);
        };

        function openChatFromNotification(chatId) {
            const contact = contacts.find(c => c.id === chatId) || groups.find(g => g.id === chatId) || { id: chatId, name: chatId };
            openChat(contact);
            if (notificationPopup) { notificationPopup.remove(); notificationPopup = null; }
        }

        // ========== –û–ë–†–ê–ë–û–¢–ö–ê –ó–ê–Ø–í–û–ö ==========
        function showFriendRequestNotification(request) {
            pendingRequests.push(request);
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `<div style="margin-bottom: 8px;">${request.fromName} —Ö–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –¥—Ä—É–∑—å—è</div><div class="notification-buttons"><button class="notification-btn btn-accept" onclick="acceptRequest('${request.from}')">‚úì –ü—Ä–∏–Ω—è—Ç—å</button><button class="notification-btn btn-decline" onclick="declineRequest('${request.from}')">‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button></div>`;
            container.appendChild(notification);
            updateNotificationBell();
            setTimeout(() => notification.remove(), 10000);
        }

        window.acceptRequest = function(requesterId) {
            if (socket) {
                socket.send(JSON.stringify({ type: 'accept_friend', requesterId: requesterId }));
                pendingRequests = pendingRequests.filter(r => r.from !== requesterId);
                updateNotificationBell();
                showNotification('–í—ã –ø—Ä–∏–Ω—è–ª–∏ –∑–∞—è–≤–∫—É', 'success');
                document.querySelectorAll('.notification').forEach(n => n.remove());
            }
        };

        window.declineRequest = function(requesterId) {
            if (socket) {
                socket.send(JSON.stringify({ type: 'decline_friend', requesterId: requesterId }));
                pendingRequests = pendingRequests.filter(r => r.from !== requesterId);
                updateNotificationBell();
                showNotification('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞', 'info');
                document.querySelectorAll('.notification').forEach(n => n.remove());
            }
        };

        // ========== –§–ê–ô–õ–´ ==========
        attachFileBtn.onclick = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*,application/pdf';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = () => {
                    if (currentChat && socket) {
                        socket.send(JSON.stringify({ 
                            type: 'file_message', 
                            to: currentChat.id, 
                            fileName: file.name, 
                            fileType: file.type, 
                            fileData: reader.result 
                        }));
                    }
                };
                reader.readAsDataURL(file);
            };
            input.click();
        };

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ù–¢–ê–ö–¢–ê–ú–ò ==========
        function blockContact(contactId) {
            if (!blockedUsers.includes(contactId)) {
                blockedUsers.push(contactId);
                localStorage.setItem('blockedUsers', JSON.stringify(blockedUsers));
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'warning');
                updateContacts();
            }
        }

        function unblockContact(contactId) {
            blockedUsers = blockedUsers.filter(id => id !== contactId);
            localStorage.setItem('blockedUsers', JSON.stringify(blockedUsers));
            showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'success');
            updateContacts();
        }

        function deleteContact(contactId) {
            if (socket) {
                socket.send(JSON.stringify({ type: 'delete_friend', friendId: contactId }));
                contacts = contacts.filter(c => c.id !== contactId);
                saveContacts();
                updateContacts();
                showNotification('–ö–æ–Ω—Ç–∞–∫—Ç —É–¥–∞–ª–µ–Ω', 'info');
            }
        }

        function clearChat(contactId) {
            if (!socket) {
                showNotification('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                return;
            }
            
            showConfirm('–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.', () => {
                socket.send(JSON.stringify({
                    type: 'clear_chat',
                    chatId: contactId
                }));
                
                if (messages[contactId]) {
                    messages[contactId] = [];
                    saveMessages();
                    if (currentChat && currentChat.id === contactId) {
                        renderMessages();
                    }
                }
                
                showNotification('–ó–∞–ø—Ä–æ—Å –Ω–∞ –æ—á–∏—Å—Ç–∫—É —á–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
            });
        }

        function clearChannel() {
            if (!socket || currentUser?.id !== 'admin') {
                showNotification('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—á–∏—â–∞—Ç—å –∫–∞–Ω–∞–ª', 'error');
                return;
            }
            
            showConfirm('–û—á–∏—Å—Ç–∏—Ç—å –∫–∞–Ω–∞–ª', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.', () => {
                socket.send(JSON.stringify({
                    type: 'clear_channel'
                }));
                
                if (messages['channel']) {
                    messages['channel'] = [];
                    saveMessages();
                    if (currentChat && currentChat.id === 'channel') {
                        renderMessages();
                    }
                }
                
                showNotification('–ö–∞–Ω–∞–ª –æ—á–∏—â–µ–Ω', 'success');
            });
        }

        // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ì–†–£–ü–ü ==========
        function createGroup() {
            createGroupModal.classList.add('active');
        }

        function addToGroup() {
            if (!currentChat || !currentChat.id.startsWith('group_')) return;
            
            selectedContactsForGroup = [];
            renderContactsForGroup();
            addToGroupModal.classList.add('active');
        }

        function renderContactsForGroup() {
            const searchTerm = searchContactsForGroup?.value?.toLowerCase() || '';
            const filtered = contacts.filter(c => 
                (c.name || '').toLowerCase().includes(searchTerm) || 
                (c.username || '').toLowerCase().includes(searchTerm)
            );
            
            contactsForGroupList.innerHTML = '';
            
            filtered.forEach(contact => {
                const isSelected = selectedContactsForGroup.includes(contact.id);
                const div = document.createElement('div');
                div.className = 'member-item';
                div.onclick = () => toggleContactSelection(contact.id);
                div.innerHTML = `
                    <div class="member-avatar">${getInitials(contact.name || contact.username)}</div>
                    <div class="member-info">
                        <div class="member-name">${contact.name || contact.username}</div>
                    </div>
                    <input type="checkbox" ${isSelected ? 'checked' : ''} style="width: 20px; height: 20px;">
                `;
                contactsForGroupList.appendChild(div);
            });
        }

        function toggleContactSelection(contactId) {
            const index = selectedContactsForGroup.indexOf(contactId);
            if (index === -1) {
                selectedContactsForGroup.push(contactId);
            } else {
                selectedContactsForGroup.splice(index, 1);
            }
            renderContactsForGroup();
        }

        function showGroupMembers() {
            if (!currentChat || !currentChat.id.startsWith('group_')) return;
            
            const group = groups.find(g => g.id === currentChat.id);
            if (!group) return;
            
            const members = group.members || [];
            let html = '';
            
            members.forEach(memberId => {
                const member = contacts.find(c => c.id === memberId) || { name: memberId };
                const isCreator = memberId === group.createdBy;
                html += `
                    <div class="member-item">
                        <div class="member-avatar">${getInitials(member.name || memberId)}</div>
                        <div class="member-info">
                            <div class="member-name">${member.name || memberId}</div>
                            <div class="member-role">${isCreator ? 'üëë –°–æ–∑–¥–∞—Ç–µ–ª—å' : '–£—á–∞—Å—Ç–Ω–∏–∫'}</div>
                        </div>
                        ${!isCreator && currentUser.id === group.createdBy ? 
                            `<span class="remove-member" onclick="kickFromGroup('${memberId}')">‚úï</span>` : ''}
                    </div>
                `;
            });
            
            groupMembersList.innerHTML = html;
            groupMembersModal.classList.add('active');
        }

        function kickFromGroup(memberId) {
            if (!currentChat || !socket) return;
            
            showConfirm('–ò—Å–∫–ª—é—á–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏—Å–∫–ª—é—á–∏—Ç—å —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –≥—Ä—É–ø–ø—ã?', () => {
                socket.send(JSON.stringify({
                    type: 'kick_from_group',
                    groupId: currentChat.id,
                    memberId: memberId
                }));
                
                const group = groups.find(g => g.id === currentChat.id);
                if (group && group.members) {
                    group.members = group.members.filter(id => id !== memberId);
                    saveGroups();
                    if (currentChat && currentChat.id === group.id) {
                        chatStatus.textContent = `${group.members.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
                    }
                }
                
                showGroupMembers();
                showNotification('–£—á–∞—Å—Ç–Ω–∏–∫ –∏—Å–∫–ª—é—á–µ–Ω', 'success');
            });
        }

        function deleteGroup() {
            if (!currentChat || !currentChat.id.startsWith('group_')) return;
            
            showConfirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.', () => {
                if (socket) {
                    socket.send(JSON.stringify({
                        type: 'delete_group',
                        groupId: currentChat.id
                    }));
                    
                    groups = groups.filter(g => g.id !== currentChat.id);
                    saveGroups();
                    
                    showScreen('contacts');
                    showNotification('–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞', 'info');
                }
            });
        }

        function leaveGroup() {
            if (!currentChat || !currentChat.id.startsWith('group_')) return;
            
            showConfirm('–ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É?', () => {
                if (socket) {
                    socket.send(JSON.stringify({
                        type: 'leave_group',
                        groupId: currentChat.id
                    }));
                    
                    const group = groups.find(g => g.id === currentChat.id);
                    if (group && group.members) {
                        group.members = group.members.filter(id => id !== currentUser.id);
                        if (group.members.length === 0) {
                            groups = groups.filter(g => g.id !== currentChat.id);
                        }
                        saveGroups();
                    }
                    
                    showScreen('contacts');
                    showNotification('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –≥—Ä—É–ø–ø—É', 'info');
                }
            });
        }

        // ========== –ú–ï–ù–Æ –ß–ê–¢–ê ==========
        function updateChatMenu() {
            if (!currentChat) { chatMenu.style.display = 'none'; return; }
            
            let menuHtml = '';
            
            if (currentChat.id === 'channel') {
                if (currentUser && currentUser.id === 'admin') {
                    menuHtml += `<div class="chat-menu-item" onclick="clearChannel()"><span>üßπ</span> –û—á–∏—Å—Ç–∏—Ç—å –∫–∞–Ω–∞–ª</div>`;
                }
            } else if (currentChat.id.startsWith('group_')) {
                const group = groups.find(g => g.id === currentChat.id);
                if (group) {
                    menuHtml += `<div class="chat-menu-item" onclick="showGroupMembers()"><span>üë•</span> –£—á–∞—Å—Ç–Ω–∏–∫–∏ (${group.members?.length || 1})</div>`;
                    if (currentUser.id === group.createdBy) {
                        menuHtml += `<div class="chat-menu-item" onclick="addToGroup()"><span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>`;
                        menuHtml += `<div class="chat-menu-item danger" onclick="deleteGroup()"><span>üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É</div>`;
                    } else {
                        menuHtml += `<div class="chat-menu-item warning" onclick="leaveGroup()"><span>üö™</span> –ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É</div>`;
                    }
                    menuHtml += `<div class="chat-menu-item" onclick="clearChat('${currentChat.id}')"><span>üßπ</span> –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</div>`;
                }
            } else {
                const isBlocked = blockedUsers.includes(currentChat.id);
                menuHtml += `<div class="chat-menu-item" onclick="clearChat('${currentChat.id}')"><span>üßπ</span> –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</div>`;
                menuHtml += `<div class="chat-menu-item" onclick="showConfirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç', '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤?', () => deleteContact('${currentChat.id}'))"><span>üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</div>`;
                if (isBlocked) {
                    menuHtml += `<div class="chat-menu-item" onclick="unblockContact('${currentChat.id}')"><span>üîì</span> –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</div>`;
                } else {
                    menuHtml += `<div class="chat-menu-item" onclick="blockContact('${currentChat.id}')"><span>üîí</span> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</div>`;
                }
            }
            
            chatMenu.innerHTML = menuHtml;
        }

        chatMenuBtn.onclick = (e) => {
            e.stopPropagation();
            updateChatMenu();
            chatMenu.classList.toggle('active');
        };

        document.addEventListener('click', () => chatMenu.classList.remove('active'));

        // ========== –ö–ê–ù–ê–õ ==========
        function openChannel() {
            currentChat = { id: 'channel', name: 'Clock Messenger', type: 'channel', verified: true };
            chatName.innerHTML = 'Clock Messenger <span class="verified-badge">‚úÖ</span>';
            chatStatus.innerHTML = `${channelStats.subscribers} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ ‚Ä¢ ${channelStats.views} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤`;
            if (!messages['channel']) messages['channel'] = [];
            renderMessages();
            channelStats.views++;
            chatInput.disabled = true;
            sendMessageBtn.disabled = true;
            if (currentUser && currentUser.id === 'admin') {
                chatInput.disabled = false;
                sendMessageBtn.disabled = false;
            }
            if (socket) socket.send(JSON.stringify({ type: 'channel_view' }));
            showScreen('chats');
        }

        // ========== –ß–ê–¢ ==========
        function openChat(contact) {
            if (blockedUsers.includes(contact.id) && contact.id !== currentUser.id) {
                showNotification('–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'warning');
                return;
            }
            if (contact.id === 'channel') { openChannel(); return; }
            
            currentChat = contact;
            chatName.textContent = contact.name || contact.username;
            
            if (contact.id.startsWith('group_')) {
                const group = groups.find(g => g.id === contact.id);
                chatStatus.textContent = `${group?.members?.length || 1} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
            } else {
                chatStatus.textContent = contact.status === 'online' ? '–≤ —Å–µ—Ç–∏' : '–Ω–µ –≤ —Å–µ—Ç–∏';
            }
            
            if (!messages[contact.id]) messages[contact.id] = [];
            renderMessages();
            chatInput.disabled = false;
            sendMessageBtn.disabled = false;
            showScreen('chats');
        }

        function renderMessages() {
            if (!currentChat) return;
            
            chatMessages.innerHTML = '';
            const chatMessagesList = messages[currentChat.id] || [];
            
            chatMessagesList.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${msg.from === currentUser.id ? 'message-mine' : 'message-other'}`;
                msgDiv.onclick = (e) => {
                    e.stopPropagation();
                    const rect = e.currentTarget.getBoundingClientRect();
                    showReactionPicker(msg.id, rect.left + rect.width/2, rect.top);
                };
                
                let content = '';
                if (msg.fileData) {
                    if (msg.fileType?.startsWith('image/')) {
                        content = `<img src="${msg.fileData}" class="file-preview" onclick="window.open('${msg.fileData}')">`;
                    } else {
                        content = `<div class="file-message" onclick="window.open('${msg.fileData}')"><span class="file-icon">üìé</span><div><div>${msg.fileName || '–§–∞–π–ª'}</div><div class="file-name">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è</div></div></div>`;
                    }
                } else {
                    content = msg.text;
                }
                
                let senderHtml = '';
                if (currentChat.id.startsWith('group_') && msg.from !== currentUser.id) {
                    const sender = contacts.find(c => c.id === msg.from) || { name: msg.from };
                    senderHtml = `<div class="message-sender">${sender.name || msg.from}</div>`;
                }
                
                let reactionsHtml = '';
                if (msg.reactions && Object.keys(msg.reactions).length > 0) {
                    reactionsHtml = '<div class="message-reactions">';
                    for (const [react, count] of Object.entries(msg.reactions)) {
                        reactionsHtml += `<span class="reaction" onclick="addReaction('${msg.id}', '${react}')">${react} ${count}</span>`;
                    }
                    reactionsHtml += '</div>';
                }
                
                msgDiv.innerHTML = `${senderHtml}<div>${content}</div><div class="message-time">${formatTime(msg.timestamp)}</div>${reactionsHtml}`;
                chatMessages.appendChild(msgDiv);
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addMessage(from, to, text, timestamp, fileData = null, fileName = null, fileType = null) {
            if (blockedUsers.includes(from) && from !== currentUser.id) return;
            if (!messages[to]) messages[to] = [];
            
            const message = { 
                id: 'msg_' + Date.now() + Math.random(), 
                from, 
                text, 
                timestamp: timestamp || new Date().toISOString(), 
                reactions: {} 
            };
            
            if (fileData) { 
                message.fileData = fileData; 
                message.fileName = fileName; 
                message.fileType = fileType; 
            }
            
            messages[to].push(message);
            saveMessages();
            
            if (currentChat && (currentChat.id === to || (currentChat.id === 'channel' && to === 'channel'))) {
                renderMessages();
            }
            
            if (from !== currentUser?.id && !blockedUsers.includes(from) && !to.startsWith('group_')) {
                const sender = contacts.find(c => c.id === from) || { name: from };
                addNotification({ from: sender.name || from, text: text || 'üìé –§–∞–π–ª', timestamp: message.timestamp, chatId: to });
            }
        }

        // ========== –ù–ê–í–ò–ì–ê–¶–ò–Ø ==========
        function showScreen(screenName) {
            authScreen.classList.remove('active');
            contactsScreen.classList.remove('active');
            chatsScreen.classList.remove('active');
            profileScreen.classList.remove('active');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            switch(screenName) {
                case 'auth': 
                    authScreen.classList.add('active'); 
                    break;
                case 'contacts': 
                    contactsScreen.classList.add('active'); 
                    document.querySelector('[data-tab="contacts"]').classList.add('active'); 
                    break;
                case 'chats': 
                    chatsScreen.classList.add('active'); 
                    document.querySelector('[data-tab="chats"]').classList.add('active'); 
                    break;
                case 'profile': 
                    profileScreen.classList.add('active'); 
                    document.querySelector('[data-tab="profile"]').classList.add('active'); 
                    break;
            }
            currentTab = screenName;
        }

        // ========== API ==========
        async function login(email, password) {
            try {
                const res = await fetch('/api/login', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ login: email, password }) 
                });
                const data = await res.json();
                if (data.success) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    currentUser = data.user;
                    saveCurrentUser();
                    updateUIForUser();
                    connectWebSocket();
                    showNotification('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
                } else {
                    showNotification(data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', 'error');
                }
            } catch (e) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        async function register(email, username, password, name, bio) {
            try {
                const res = await fetch('/api/register', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ email, username, password, name, bio }) 
                });
                const data = await res.json();
                if (data.success) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    currentUser = data.user;
                    saveCurrentUser();
                    updateUIForUser();
                    connectWebSocket();
                    showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞', 'success');
                } else {
                    showNotification(data.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'error');
                }
            } catch (e) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // ========== WEB SOCKET ==========
        function connectWebSocket() {
            const wsUrl = `wss://${window.location.host}`;
            socket = new WebSocket(wsUrl);
            
            socket.onopen = () => {
                console.log('WebSocket –æ—Ç–∫—Ä—ã—Ç');
                statusEl.className = 'status-connected';
                statusEl.innerHTML = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                if (token) {
                    socket.send(JSON.stringify({ type: 'auth', token }));
                }
            };
            
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ:', data.type);
                
                switch(data.type) {
                    case 'auth_success':
                        console.log('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
                        currentUser = { ...currentUser, ...data.user };
                        contacts = data.contacts || [];
                        saveContacts();
                        saveCurrentUser();
                        updateContacts();
                        showScreen('contacts');
                        break;
                        
                    case 'friends_list':
                        console.log('üìã –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π:', data.friends);
                        contacts = data.friends || [];
                        saveContacts();
                        updateContacts();
                        break;
                        
                    case 'friend_request':
                        console.log('üîî –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç:', data.from);
                        showFriendRequestNotification({ 
                            from: data.from, 
                            fromName: data.fromName || data.from 
                        });
                        break;
                        
                    case 'friend_request_sent':
                        showNotification(`–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ${data.to}`, 'success');
                        break;
                        
                    case 'friend_request_accepted':
                        showNotification(data.message, 'success');
                        break;
                        
                    case 'message':
                        console.log('üí¨ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç:', data.from);
                        addMessage(data.from, data.from, data.text, data.timestamp);
                        if (currentChat && currentChat.id === data.from) {
                            renderMessages();
                        }
                        break;
                        
                    case 'file_message':
                        console.log('üìé –ù–æ–≤—ã–π —Ñ–∞–π–ª –æ—Ç:', data.from);
                        addMessage(data.from, data.from, '', data.timestamp, data.fileData, data.fileName, data.fileType);
                        if (currentChat && currentChat.id === data.from) {
                            renderMessages();
                        }
                        break;
                        
                    case 'channel_message':
                        console.log('üì¢ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª–µ');
                        if (currentUser) {
                            addMessage('channel', 'channel', data.content, data.timestamp, data.fileData, data.fileName, data.fileType);
                        }
                        break;
                        
                    case 'channel_stats':
                        channelStats = { subscribers: data.subscribers, views: data.views };
                        if (currentChat && currentChat.id === 'channel') {
                            chatStatus.innerHTML = `${channelStats.subscribers} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ ‚Ä¢ ${channelStats.views} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤`;
                        }
                        break;
                        
                    case 'chat_cleared':
                        console.log('üßπ –ß–∞—Ç –æ—á–∏—â–µ–Ω:', data.chatId);
                        if (messages[data.chatId]) {
                            messages[data.chatId] = [];
                            saveMessages();
                            if (currentChat && currentChat.id === data.chatId) {
                                renderMessages();
                            }
                        }
                        showNotification('–ß–∞—Ç –±—ã–ª –æ—á–∏—â–µ–Ω', 'info');
                        break;
                        
                    case 'channel_cleared':
                        console.log('üßπ –ö–∞–Ω–∞–ª –æ—á–∏—â–µ–Ω');
                        if (messages['channel']) {
                            messages['channel'] = [];
                            saveMessages();
                            if (currentChat && currentChat.id === 'channel') {
                                renderMessages();
                            }
                        }
                        showNotification('–ö–∞–Ω–∞–ª –±—ã–ª –æ—á–∏—â–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º', 'warning');
                        break;
                        
                    case 'group_created':
                        if (data.group) {
                            groups.push(data.group);
                            saveGroups();
                            updateContacts();
                            showNotification(`–ì—Ä—É–ø–ø–∞ "${data.group.name}" —Å–æ–∑–¥–∞–Ω–∞`, 'success');
                        }
                        break;
                        
                    case 'group_members_added':
                        if (data.groupId) {
                            const group = groups.find(g => g.id === data.groupId);
                            if (group && data.members) {
                                if (!group.members) group.members = [];
                                group.members = [...new Set([...group.members, ...data.members])];
                                saveGroups();
                                if (currentChat && currentChat.id === data.groupId) {
                                    chatStatus.textContent = `${group.members.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
                                }
                            }
                        }
                        showNotification('–ù–æ–≤—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã', 'success');
                        break;
                        
                    case 'member_kicked':
                        if (data.groupId && data.memberId === currentUser?.id) {
                            groups = groups.filter(g => g.id !== data.groupId);
                            saveGroups();
                            updateContacts();
                            if (currentChat && currentChat.id === data.groupId) {
                                showScreen('contacts');
                            }
                            showNotification('–í–∞—Å –∏—Å–∫–ª—é—á–∏–ª–∏ –∏–∑ –≥—Ä—É–ø–ø—ã', 'warning');
                        } else if (data.groupId) {
                            const group = groups.find(g => g.id === data.groupId);
                            if (group && group.members) {
                                group.members = group.members.filter(id => id !== data.memberId);
                                saveGroups();
                                if (currentChat && currentChat.id === data.groupId) {
                                    chatStatus.textContent = `${group.members.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
                                }
                            }
                        }
                        break;
                        
                    case 'group_deleted':
                        groups = groups.filter(g => g.id !== data.groupId);
                        saveGroups();
                        updateContacts();
                        if (currentChat && currentChat.id === data.groupId) {
                            showScreen('contacts');
                        }
                        showNotification('–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞', 'info');
                        break;
                        
                    case 'reaction':
                        if (data.chatId && messages[data.chatId]) {
                            const msg = messages[data.chatId].find(m => m.id === data.messageId);
                            if (msg) {
                                if (!msg.reactions) msg.reactions = {};
                                if (data.remove) {
                                    if (msg.reactions[data.reaction]) {
                                        msg.reactions[data.reaction]--;
                                        if (msg.reactions[data.reaction] <= 0) {
                                            delete msg.reactions[data.reaction];
                                        }
                                    }
                                } else {
                                    msg.reactions[data.reaction] = (msg.reactions[data.reaction] || 0) + 1;
                                }
                                if (currentChat && currentChat.id === data.chatId) {
                                    renderMessages();
                                }
                            }
                        }
                        break;
                        
                    case 'error':
                        showNotification(data.message, 'error');
                        break;
                        
                    default:
                        console.log('‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø:', data.type);
                }
            };
            
            socket.onclose = () => {
                console.log('WebSocket –∑–∞–∫—Ä—ã—Ç');
                statusEl.className = 'status-disconnected';
                statusEl.innerHTML = 'üî¥ –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
                setTimeout(connectWebSocket, 3000);
            };
            
            socket.onerror = (error) => {
                console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
            };
        }

        // ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ==========
        function updateUIForUser() {
            if (currentUser) {
                authButton.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userName.textContent = currentUser.name || currentUser.username;
                userAvatar.textContent = getInitials(currentUser.name || currentUser.username);
                profileName.textContent = currentUser.name || currentUser.username;
                profileUsername.textContent = '@' + currentUser.username;
                profileBio.textContent = currentUser.bio || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
                profileAvatar.textContent = getInitials(currentUser.name || currentUser.username);
            } else {
                authButton.classList.remove('hidden');
                userInfo.classList.add('hidden');
            }
            updateContacts();
        }

        function updateContacts() {
            const searchTerm = searchContacts?.value?.toLowerCase() || '';
            contactsList.innerHTML = '';
            
            if (!currentUser) return;
            
            // –ö–∞–Ω–∞–ª
            const channelEl = document.createElement('div');
            channelEl.className = 'contact-item';
            channelEl.innerHTML = `<div class="contact-avatar" style="background: var(--primary);">üì¢</div><div class="contact-info"><div class="contact-name">Clock Messenger <span class="verified-badge">‚úÖ</span></div><div class="contact-status">${channelStats.subscribers} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ ‚Ä¢ ${channelStats.views} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div></div>`;
            channelEl.onclick = openChannel;
            contactsList.appendChild(channelEl);
            
            // –ì—Ä—É–ø–ø—ã
            groups.forEach(group => {
                if (group.name.toLowerCase().includes(searchTerm)) {
                    const groupEl = document.createElement('div');
                    groupEl.className = 'contact-item';
                    groupEl.innerHTML = `<div class="contact-avatar" style="background: var(--secondary);">üë•</div><div class="contact-info"><div class="contact-name">${group.name} <span class="group-badge">–≥—Ä—É–ø–ø–∞</span></div><div class="contact-status">${group.members?.length || 1} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div></div>`;
                    groupEl.onclick = () => openChat(group);
                    contactsList.appendChild(groupEl);
                }
            });
            
            // –ö–æ–Ω—Ç–∞–∫—Ç—ã
            const filtered = contacts.filter(c => 
                (c.name || '').toLowerCase().includes(searchTerm) || 
                (c.username || '').toLowerCase().includes(searchTerm)
            );
            
            filtered.forEach(contact => {
                const isBlocked = blockedUsers.includes(contact.id);
                const el = document.createElement('div');
                el.className = 'contact-item';
                el.innerHTML = `<div class="contact-avatar">${getInitials(contact.name || contact.username)}</div><div class="contact-info"><div class="contact-name">${contact.name || contact.username}${isBlocked ? ' <span class="blocked-badge">–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>' : ''}</div><div class="contact-status">${contact.status === 'online' ? 'üü¢ –≤ —Å–µ—Ç–∏' : '‚ö´ –Ω–µ –≤ —Å–µ—Ç–∏'}</div></div>`;
                el.onclick = () => openChat(contact);
                contactsList.appendChild(el);
            });
            
            contactsCount.textContent = filtered.length;
            channelsCount.textContent = 1 + groups.length;
        }

        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========
        authButton.onclick = () => showScreen('auth');
        
        loginTab.onclick = () => {
            loginTab.classList.add('active');
            registerTab.classList.remove('active');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
        };
        
        registerTab.onclick = () => {
            registerTab.classList.add('active');
            loginTab.classList.remove('active');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
        };
        
        loginSubmit.onclick = () => login(loginEmail.value, loginPassword.value);
        
        registerSubmit.onclick = () => register(
            registerEmail.value, 
            registerUsername.value, 
            registerPassword.value, 
            registerName.value, 
            registerBio.value
        );
        
        addFriendBtn.onclick = () => addFriendModal.classList.add('active');
        
        addFriendCancel.onclick = () => {
            addFriendModal.classList.remove('active');
            addFriendInput.value = '';
        };
        
        addFriendConfirm.onclick = () => {
            if (socket && addFriendInput.value) {
                socket.send(JSON.stringify({ 
                    type: 'add_friend', 
                    friendId: addFriendInput.value 
                }));
                addFriendModal.classList.remove('active');
                addFriendInput.value = '';
                showNotification('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
            }
        };
        
        createGroupBtn.onclick = () => createGroup();
        
        createGroupCancel.onclick = () => {
            createGroupModal.classList.remove('active');
            groupName.value = '';
            groupDescription.value = '';
        };
        
        createGroupConfirm.onclick = () => {
            const name = groupName.value.trim();
            if (!name) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã', 'error');
                return;
            }
            
            if (socket) {
                const groupId = 'group_' + Date.now();
                const newGroup = {
                    id: groupId,
                    name: name,
                    description: groupDescription.value.trim(),
                    createdBy: currentUser.id,
                    members: [currentUser.id],
                    createdAt: new Date().toISOString()
                };
                
                socket.send(JSON.stringify({
                    type: 'create_group',
                    group: newGroup
                }));
                
                groups.push(newGroup);
                saveGroups();
                updateContacts();
                
                createGroupModal.classList.remove('active');
                groupName.value = '';
                groupDescription.value = '';
                
                showNotification('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success');
            }
        };
        
        addToGroupCancel.onclick = () => {
            addToGroupModal.classList.remove('active');
            selectedContactsForGroup = [];
        };
        
        addToGroupConfirm.onclick = () => {
            if (socket && currentChat && selectedContactsForGroup.length > 0) {
                socket.send(JSON.stringify({
                    type: 'add_to_group',
                    groupId: currentChat.id,
                    members: selectedContactsForGroup
                }));
                
                const group = groups.find(g => g.id === currentChat.id);
                if (group) {
                    if (!group.members) group.members = [];
                    group.members = [...new Set([...group.members, ...selectedContactsForGroup])];
                    saveGroups();
                    if (currentChat && currentChat.id === group.id) {
                        chatStatus.textContent = `${group.members.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
                    }
                }
                
                addToGroupModal.classList.remove('active');
                selectedContactsForGroup = [];
                showNotification('–£—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã', 'success');
            }
        };
        
        groupMembersClose.onclick = () => {
            groupMembersModal.classList.remove('active');
        };
        
        editProfileBtn.onclick = () => {
            editName.value = currentUser.name || '';
            editBio.value = currentUser.bio || '';
            editProfileModal.classList.add('active');
        };
        
        editProfileCancel.onclick = () => editProfileModal.classList.remove('active');
        
        editProfileConfirm.onclick = () => {
            if (socket) {
                socket.send(JSON.stringify({ 
                    type: 'update_profile', 
                    name: editName.value, 
                    bio: editBio.value 
                }));
                currentUser.name = editName.value;
                currentUser.bio = editBio.value;
                saveCurrentUser();
                updateUIForUser();
            }
            editProfileModal.classList.remove('active');
            showNotification('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
        };
        
        sendMessageBtn.onclick = () => {
            if (!socket || !currentChat || !chatInput.value) return;
            const text = chatInput.value.trim();
            if (!text) return;
            
            socket.send(JSON.stringify({ 
                type: 'message', 
                to: currentChat.id, 
                text: text 
            }));
            
            addMessage(currentUser.id, currentChat.id, text);
            chatInput.value = '';
        };
        
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessageBtn.click();
        });
        
        searchContacts?.addEventListener('input', updateContacts);
        searchContactsForGroup?.addEventListener('input', renderContactsForGroup);
        
        tabButtons.forEach(btn => {
            btn.onclick = () => showScreen(btn.dataset.tab);
        });

        document.addEventListener('click', (e) => {
            if (notificationPopup && !notificationPopup.contains(e.target) && e.target !== notificationBell) {
                notificationPopup.remove();
                notificationPopup = null;
            }
        });

        setInterval(() => {
            if (socket && currentUser) {
                socket.send(JSON.stringify({ type: 'get_channel_stats' }));
            }
        }, 30000);

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        if (token && currentUser) {
            connectWebSocket();
            showScreen('contacts');
            updateUIForUser();
        } else {
            showScreen('auth');
        }
    </script>
</body>
</html>














