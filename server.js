// ะะพะดะบะปััะฐะตะผ ะฑะธะฑะปะธะพัะตะบะธ
const express = require('express');
const http = require('http');
const WebSocket = require('ws');

// ะกะพะทะดะฐะตะผ ะฒะตะฑ-ัะตัะฒะตั
const app = express();
const server = http.createServer(app);

// ะกะพะทะดะฐะตะผ ัะตัะฒะตั WebSockets ะธ ะฟัะธะบัะตะฟะปัะตะผ ะตะณะพ ะบ ะพะฑััะฝะพะผั ัะตัะฒะตัั
const wss = new WebSocket.Server({ server });

// ะกะบะปะฐะด ะดะปั ััะฐะฝะตะฝะธั ะฒัะตั ะฟะพะดะบะปััะธะฒัะธััั ะบะปะธะตะฝัะพะฒ
// Map - ััะพ ะบะฐะบ ัะปะพะฒะฐัั: ะฟะพ ะบะปััั (id ะฟะพะปัะทะพะฒะฐัะตะปั) ะผะพะถะฝะพ ะฟะพะปััะธัั ะทะฝะฐัะตะฝะธะต (ัะพะตะดะธะฝะตะฝะธะต)
const clients = new Map();

// ะญัะพ ัะพะฑััะธะต ััะฐะฑะฐััะฒะฐะตั, ะบะพะณะดะฐ ะบัะพ-ัะพ ะฟะพะดะบะปััะฐะตััั ะบ ะฝะฐัะตะผั ัะตัะฒะตัั
wss.on('connection', (ws) => {
    console.log('โ ะะพะฒัะน ะบะปะธะตะฝั ะฟะพะดะบะปััะธะปัั');
    
    let userId = null; // ะะดะตัั ะฑัะดะตะผ ััะฐะฝะธัั id ัะตะบััะตะณะพ ะบะปะธะตะฝัะฐ

    // ะกะพะฑััะธะต, ะบะพะณะดะฐ ะบะปะธะตะฝั ะพัะฟัะฐะฒะปัะตั ัะพะพะฑัะตะฝะธะต
    ws.on('message', (message) => {
        try {
            // ะัะตะฒัะฐัะฐะตะผ ัะตะบััะพะฒะพะต ัะพะพะฑัะตะฝะธะต ะฒ JavaScript ะพะฑัะตะบั
            const data = JSON.parse(message);
            console.log('๐จ ะะพะปััะตะฝะพ ัะพะพะฑัะตะฝะธะต:', data);

            // ะกะผะพััะธะผ, ััะพ ัะพัะตั ะบะปะธะตะฝั
            switch (data.type) {
                case 'auth':
                    // ะะปะธะตะฝั ัะพัะตั ะฐะฒัะพัะธะทะพะฒะฐัััั (ะฟัะตะดััะฐะฒะธัััั)
                    userId = data.userId;
                    clients.set(userId, ws); // ะะฐะฟะพะผะธะฝะฐะตะผ ะตะณะพ ัะพะตะดะธะฝะตะฝะธะต
                    console.log(`๐ค ะะพะปัะทะพะฒะฐัะตะปั ${userId} ะฐะฒัะพัะธะทะพะฒะฐะฝ`);
                    
                    // ะัะฟัะฐะฒะปัะตะผ ะฟะพะดัะฒะตัะถะดะตะฝะธะต
                    ws.send(JSON.stringify({ 
                        type: 'auth_success', 
                        userId: userId 
                    }));
                    break;

                case 'message':
                    // ะะปะธะตะฝั ัะพัะตั ะพัะฟัะฐะฒะธัั ัะพะพะฑัะตะฝะธะต ะดััะณะพะผั
                    const { to, text } = data;
                    
                    // ะัะตะผ ะฟะพะปััะฐัะตะปั ะฒ ะฝะฐัะตะผ ัะบะปะฐะดะต
                    const targetSocket = clients.get(to);
                    
                    if (targetSocket && targetSocket.readyState === WebSocket.OPEN) {
                        // ะะพะปััะฐัะตะปั ะพะฝะปะฐะนะฝ - ะพัะฟัะฐะฒะปัะตะผ ะตะผั
                        targetSocket.send(JSON.stringify({
                            type: 'message',
                            from: userId,
                            text: text,
                            timestamp: new Date().toISOString()
                        }));
                        console.log(`โ๏ธ ะกะพะพะฑัะตะฝะธะต ะพั ${userId} ะบ ${to}: "${text}"`);
                    } else {
                        console.log(`๐ด ะะพะปัะทะพะฒะฐัะตะปั ${to} ะฝะต ะฒ ัะตัะธ`);
                        // ะะดะตัั ะผะพะถะฝะพ ัะพััะฐะฝะธัั ัะพะพะฑัะตะฝะธะต, ััะพะฑั ะพัะฟัะฐะฒะธัั ะฟะพะทะถะต
                    }
                    break;
            }
        } catch (e) {
            console.log('โ ะัะธะฑะบะฐ ะพะฑัะฐะฑะพัะบะธ ัะพะพะฑัะตะฝะธั:', e);
        }
    });

    // ะกะพะฑััะธะต, ะบะพะณะดะฐ ะบะปะธะตะฝั ะพัะบะปััะฐะตััั
    ws.on('close', () => {
        if (userId) {
            clients.delete(userId); // ะฃะดะฐะปัะตะผ ะตะณะพ ะธะท ัะบะปะฐะดะฐ
            console.log(`๐ ะะพะปัะทะพะฒะฐัะตะปั ${userId} ะพัะบะปััะธะปัั`);
        }
    });
});

// ะัะพััะฐั ัััะฐะฝะธัะบะฐ ะดะปั ะฟัะพะฒะตัะบะธ, ััะพ ัะตัะฒะตั ัะฐะฑะพัะฐะตั
app.get('/', (req, res) => {
  res.sendFile(__dirname + '/index.html');
});

// ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั ะฝะฐ ะฟะพััั 3000
const PORT = 3000;
server.listen(PORT, () => {
    console.log(`๐ ะกะตัะฒะตั ะทะฐะฟััะตะฝ ะฝะฐ http://localhost:${PORT}`);
    console.log(`๐ WebSocket ัะตัะฒะตั ัะฐะฑะพัะฐะตั ะฝะฐ ws://localhost:${PORT}`);
});
