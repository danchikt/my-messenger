<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#8774e1">
    <link rel="manifest" href="/manifest.json">
    <title>–ú–æ–π –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        :root {
            --primary: #8774e1;
            --primary-dark: #6b5b9e;
            --secondary: #31c4b2;
            --bg: #f8f9fa;
            --surface: #ffffff;
            --text: #1c1e21;
            --text-secondary: #65676b;
            --border: #e4e6eb;
            --error: #f15b6f;
            --success: #31c4b2;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
        }

        .app-container {
            width: 100%;
            max-width: 500px;
            height: 100vh;
            max-height: 900px;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 0;
            box-shadow: none;
        }

        @media (min-width: 500px) {
            .app-container {
                height: 95vh;
                border-radius: 30px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            }
        }

        /* –°—Ç–∞—Ç—É—Å –±–∞—Ä */
        .status-bar {
            background: var(--surface);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            font-weight: 500;
        }

        .status-connected {
            color: var(--success);
        }

        .status-disconnected {
            color: var(--error);
        }

        .auth-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .auth-button:hover {
            background: var(--primary-dark);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: none;
        }

        .main-content.active {
            display: block;
        }

        /* –≠–∫—Ä–∞–Ω—ã */
        .auth-screen, .contacts-screen, .chats-screen, .profile-screen, .channel-screen {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* –§–æ—Ä–º—ã */
        .auth-form {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            margin-top: 20px;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            border-bottom: 2px solid var(--border);
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .auth-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .auth-input {
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: var(--bg);
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-submit {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* –ü–æ–∏—Å–∫ */
        .search-bar {
            background: var(--surface);
            border-radius: 20px;
            padding: 8px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border);
        }

        .search-bar input {
            flex: 1;
            border: none;
            background: none;
            padding: 8px 0;
            font-size: 16px;
        }

        .search-bar input:focus {
            outline: none;
        }

        /* –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ */
        .contacts-list, .chats-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .contact-item, .chat-item {
            background: var(--surface);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .contact-item:hover, .chat-item:hover {
            background: #f0f2f5;
        }

        .contact-avatar, .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
        }

        .contact-info, .chat-info {
            flex: 1;
        }

        .contact-name, .chat-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .contact-status, .chat-last-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .profile-header {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 40px;
            margin: 0 auto 16px;
            cursor: pointer;
            position: relative;
        }

        .avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .profile-avatar-large:hover .avatar-overlay {
            opacity: 1;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .profile-username {
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-size: 16px;
        }

        .profile-bio {
            color: var(--text);
            margin-bottom: 20px;
            font-size: 16px;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-weight: 600;
            font-size: 20px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* –ö–∞–Ω–∞–ª */
        .channel-header {
            background: var(--surface);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
        }

        .channel-badge {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            margin-top: 8px;
        }

        .channel-message {
            background: var(--surface);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .channel-message-author {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .channel-message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* –¢–∞–±—ã */
        .bottom-tabs {
            display: flex;
            justify-content: space-around;
            padding: 8px 16px;
            background: var(--surface);
            border-top: 1px solid var(--border);
        }

        .tab-button {
            background: none;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 20px;
            transition: all 0.2s;
        }

        .tab-button.active {
            background: var(--primary);
            color: white;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: 16px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-button-primary {
            background: var(--primary);
            color: white;
        }

        .modal-button-secondary {
            background: var(--border);
            color: var(--text);
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            width: 90%;
            max-width: 400px;
        }

        .notification {
            background: var(--surface);
            border-left: 4px solid var(--primary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--error);
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- –°—Ç–∞—Ç—É—Å –±–∞—Ä -->
        <div class="status-bar">
            <div id="statusDisplay" class="status-disconnected">üî¥ –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
            <div id="authContainer">
                <button id="authButton" class="auth-button">–í–æ–π—Ç–∏</button>
                <div id="userInfo" class="user-info hidden">
                    <div id="userAvatar" class="user-avatar-small">?</div>
                    <span id="userName"></span>
                </div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div id="authScreen" class="main-content">
            <div class="auth-screen">
                <div class="auth-form">
                    <div class="auth-tabs">
                        <button id="loginTab" class="auth-tab active">–í—Ö–æ–¥</button>
                        <button id="registerTab" class="auth-tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                    </div>
                    
                    <div id="loginForm">
                        <input type="text" id="loginEmail" class="auth-input" placeholder="Email –∏–ª–∏ username">
                        <input type="password" id="loginPassword" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
                        <button id="loginSubmit" class="auth-submit">–í–æ–π—Ç–∏</button>
                    </div>
                    
                    <div id="registerForm" class="hidden">
                        <input type="email" id="registerEmail" class="auth-input" placeholder="Email">
                        <input type="text" id="registerUsername" class="auth-input" placeholder="Username">
                        <input type="password" id="registerPassword" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
                        <input type="text" id="registerName" class="auth-input" placeholder="–ò–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                        <input type="text" id="registerBio" class="auth-input" placeholder="–û —Å–µ–±–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                        <button id="registerSubmit" class="auth-submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="contactsScreen" class="main-content">
            <div class="contacts-screen">
                <div class="search-bar">
                    <span>üîç</span>
                    <input type="text" id="searchContacts" placeholder="–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...">
                    <button id="addFriendBtn" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚ûï</button>
                </div>
                <div id="contactsList" class="contacts-list">
                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>

        <div id="chatsScreen" class="main-content">
            <div class="chats-screen">
                <div id="chatsList" class="chats-list">
                    <!-- –ß–∞—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>

        <div id="profileScreen" class="main-content">
            <div class="profile-screen">
                <div class="profile-header">
                    <div class="profile-avatar-large" id="profileAvatar">
                        ?
                        <div class="avatar-overlay" id="editAvatarBtn">üì∑</div>
                    </div>
                    <div class="profile-name" id="profileName"></div>
                    <div class="profile-username" id="profileUsername"></div>
                    <div class="profile-bio" id="profileBio"></div>
                    <button id="editProfileBtn" class="auth-button">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                </div>
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="contactsCount">0</div>
                        <div class="stat-label">–∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="channelsCount">1</div>
                        <div class="stat-label">–∫–∞–Ω–∞–ª</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="channelScreen" class="main-content">
            <div class="channel-screen">
                <div class="channel-header">
                    <h2>üì¢ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª</h2>
                    <span class="channel-badge">‚úÖ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π</span>
                </div>
                <div id="channelMessages" style="flex: 1; overflow-y: auto; margin-bottom: 12px;">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞ -->
                </div>
                <div id="channelInputArea" class="hidden" style="display: flex; gap: 8px; padding: 8px 0;">
                    <input type="text" id="channelInput" class="auth-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –≤ –∫–∞–Ω–∞–ª..." style="margin: 0;">
                    <button id="sendChannelBtn" class="auth-submit" style="width: auto; padding: 0 20px; margin: 0;">‚û§</button>
                </div>
            </div>
        </div>

        <!-- –ù–∏–∂–Ω–∏–µ —Ç–∞–±—ã -->
        <div class="bottom-tabs">
            <button class="tab-button active" data-tab="contacts">üë• –ö–æ–Ω—Ç–∞–∫—Ç—ã</button>
            <button class="tab-button" data-tab="chats">üí¨ –ß–∞—Ç—ã</button>
            <button class="tab-button" data-tab="profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
            <button class="tab-button" data-tab="channel">üì¢ –ö–∞–Ω–∞–ª</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="addFriendModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</div>
            <input type="text" id="addFriendInput" class="modal-input" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ @username">
            <div class="modal-buttons">
                <button id="addFriendCancel" class="modal-button modal-button-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button id="addFriendConfirm" class="modal-button modal-button-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>
            <input type="text" id="editName" class="modal-input" placeholder="–ò–º—è">
            <input type="text" id="editBio" class="modal-input" placeholder="–û —Å–µ–±–µ">
            <input type="file" id="editAvatarFile" accept="image/*" class="modal-input" style="padding: 8px;">
            <div class="modal-buttons">
                <button id="editProfileCancel" class="modal-button modal-button-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button id="editProfileConfirm" class="modal-button modal-button-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="notificationContainer" class="notification-container"></div>

    <script>
        // ========== –°–û–°–¢–û–Ø–ù–ò–ï ==========
        let token = localStorage.getItem('token');
        let currentUser = null;
        let contacts = [];
        let channelMessages = [];
        let socket = null;
        let currentTab = 'contacts';

        // ========== DOM –≠–õ–ï–ú–ï–ù–¢–´ ==========
        const statusEl = document.getElementById('statusDisplay');
        const authButton = document.getElementById('authButton');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        
        const authScreen = document.getElementById('authScreen');
        const contactsScreen = document.getElementById('contactsScreen');
        const chatsScreen = document.getElementById('chatsScreen');
        const profileScreen = document.getElementById('profileScreen');
        const channelScreen = document.getElementById('channelScreen');
        
        const tabButtons = document.querySelectorAll('.tab-button');
        
        // –§–æ—Ä–º—ã
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const loginSubmit = document.getElementById('loginSubmit');
        
        const registerEmail = document.getElementById('registerEmail');
        const registerUsername = document.getElementById('registerUsername');
        const registerPassword = document.getElementById('registerPassword');
        const registerName = document.getElementById('registerName');
        const registerBio = document.getElementById('registerBio');
        const registerSubmit = document.getElementById('registerSubmit');
        
        // –ö–æ–Ω—Ç–∞–∫—Ç—ã
        const contactsList = document.getElementById('contactsList');
        const searchContacts = document.getElementById('searchContacts');
        const addFriendBtn = document.getElementById('addFriendBtn');
        
        // –ü—Ä–æ—Ñ–∏–ª—å
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profileUsername = document.getElementById('profileUsername');
        const profileBio = document.getElementById('profileBio');
        const contactsCount = document.getElementById('contactsCount');
        const channelsCount = document.getElementById('channelsCount');
        const editProfileBtn = document.getElementById('editProfileBtn');
        
        // –ö–∞–Ω–∞–ª
        const channelMessagesList = document.getElementById('channelMessages');
        const channelInput = document.getElementById('channelInput');
        const sendChannelBtn = document.getElementById('sendChannelBtn');
        const channelInputArea = document.getElementById('channelInputArea');
        
        // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        const addFriendModal = document.getElementById('addFriendModal');
        const addFriendInput = document.getElementById('addFriendInput');
        const addFriendConfirm = document.getElementById('addFriendConfirm');
        const addFriendCancel = document.getElementById('addFriendCancel');
        
        const editProfileModal = document.getElementById('editProfileModal');
        const editName = document.getElementById('editName');
        const editBio = document.getElementById('editBio');
        const editAvatarFile = document.getElementById('editAvatarFile');
        const editProfileConfirm = document.getElementById('editProfileConfirm');
        const editProfileCancel = document.getElementById('editProfileCancel');

        // ========== –£–¢–ò–õ–ò–¢–´ ==========
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <span onclick="this.parentElement.parentElement.remove()" style="cursor: pointer;">‚úï</span>
                </div>
            `;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }

        // ========== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –≠–ö–†–ê–ù–û–í ==========
        function showScreen(screenName) {
            authScreen.classList.remove('active');
            contactsScreen.classList.remove('active');
            chatsScreen.classList.remove('active');
            profileScreen.classList.remove('active');
            channelScreen.classList.remove('active');
            
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            switch(screenName) {
                case 'auth':
                    authScreen.classList.add('active');
                    break;
                case 'contacts':
                    contactsScreen.classList.add('active');
                    document.querySelector('[data-tab="contacts"]').classList.add('active');
                    break;
                case 'chats':
                    chatsScreen.classList.add('active');
                    document.querySelector('[data-tab="chats"]').classList.add('active');
                    break;
                case 'profile':
                    profileScreen.classList.add('active');
                    document.querySelector('[data-tab="profile"]').classList.add('active');
                    break;
                case 'channel':
                    channelScreen.classList.add('active');
                    document.querySelector('[data-tab="channel"]').classList.add('active');
                    break;
            }
            currentTab = screenName;
        }

        // ========== –†–ê–ë–û–¢–ê –° API ==========
        async function login(email, password) {
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ login: email, password })
                });
                const data = await res.json();
                if (data.success) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    currentUser = data.user;
                    updateUIForUser();
                    connectWebSocket();
                    showNotification('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
                } else {
                    showNotification(data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', 'error');
                }
            } catch (e) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        async function register(email, username, password, name, bio) {
            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, username, password, name, bio })
                });
                const data = await res.json();
                if (data.success) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    currentUser = data.user;
                    updateUIForUser();
                    connectWebSocket();
                    showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞', 'success');
                } else {
                    showNotification(data.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'error');
                }
            } catch (e) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // ========== WEB SOCKET ==========
        function connectWebSocket() {
            const wsUrl = 'wss://' + window.location.host;
            socket = new WebSocket(wsUrl);
            
            socket.onopen = () => {
                statusEl.className = 'status-connected';
                statusEl.innerHTML = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                socket.send(JSON.stringify({ type: 'auth', token }));
            };
            
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('üì®', data);
                
                switch(data.type) {
                    case 'auth_success':
                        currentUser = { ...currentUser, ...data.user };
                        contacts = data.contacts || [];
                        updateContacts();
                        showScreen('contacts');
                        break;
                        
                    case 'friends_list':
                        contacts = data.friends || [];
                        updateContacts();
                        break;
                        
                    case 'friend_request':
                        showNotification(`–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç ${data.fromName}`, 'info');
                        break;
                        
                    case 'friend_request_sent':
                        showNotification(`–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ${data.to}`, 'success');
                        break;
                        
                    case 'channel_message':
                        addChannelMessageToUI(data);
                        break;
                        
                    case 'error':
                        showNotification(data.message, 'error');
                        break;
                }
            };
            
            socket.onclose = () => {
                statusEl.className = 'status-disconnected';
                statusEl.innerHTML = 'üî¥ –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
                setTimeout(connectWebSocket, 3000);
            };
        }

        // ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ==========
        function updateUIForUser() {
            authButton.classList.add('hidden');
            userInfo.classList.remove('hidden');
            userName.textContent = currentUser.name || currentUser.username;
            userAvatar.textContent = getInitials(currentUser.name || currentUser.username);
            
            // –ü—Ä–æ—Ñ–∏–ª—å
            profileName.textContent = currentUser.name || currentUser.username;
            profileUsername.textContent = '@' + currentUser.username;
            profileBio.textContent = currentUser.bio || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
            profileAvatar.textContent = getInitials(currentUser.name || currentUser.username);
            
            // –ö–∞–Ω–∞–ª (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–ø—É—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É)
            if (currentUser.id === 'admin') {
                channelInputArea.classList.remove('hidden');
            }
        }

        function updateContacts() {
            const searchTerm = searchContacts?.value?.toLowerCase() || '';
            const filtered = contacts.filter(c => 
                (c.name || '').toLowerCase().includes(searchTerm) || 
                (c.username || '').toLowerCase().includes(searchTerm)
            );
            
            contactsList.innerHTML = '';
            filtered.forEach(contact => {
                const el = document.createElement('div');
                el.className = 'contact-item';
                el.innerHTML = `
                    <div class="contact-avatar">${getInitials(contact.name || contact.username)}</div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.name || contact.username}</div>
                        <div class="contact-status">${contact.status === 'online' ? 'üü¢ –≤ —Å–µ—Ç–∏' : '‚ö´ –Ω–µ –≤ —Å–µ—Ç–∏'}</div>
                    </div>
                `;
                el.onclick = () => openChat(contact);
                contactsList.appendChild(el);
            });
            
            contactsCount.textContent = filtered.length;
        }

        function addChannelMessageToUI(msg) {
            const el = document.createElement('div');
            el.className = 'channel-message';
            el.innerHTML = `
                <div class="channel-message-author">${msg.author || '–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª'}</div>
                <div>${msg.content}</div>
                <div class="channel-message-time">${formatTime(msg.timestamp)}</div>
            `;
            channelMessagesList.appendChild(el);
            channelMessagesList.scrollTop = channelMessagesList.scrollHeight;
        }

        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==========
        authButton.onclick = () => showScreen('auth');
        
        loginTab.onclick = () => {
            loginTab.classList.add('active');
            registerTab.classList.remove('active');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
        };
        
        registerTab.onclick = () => {
            registerTab.classList.add('active');
            loginTab.classList.remove('active');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
        };
        
        loginSubmit.onclick = () => login(loginEmail.value, loginPassword.value);
        
        registerSubmit.onclick = () => register(
            registerEmail.value,
            registerUsername.value,
            registerPassword.value,
            registerName.value,
            registerBio.value
        );
        
        addFriendBtn.onclick = () => addFriendModal.classList.add('active');
        
        addFriendCancel.onclick = () => {
            addFriendModal.classList.remove('active');
            addFriendInput.value = '';
        };
        
        addFriendConfirm.onclick = () => {
            if (socket && addFriendInput.value) {
                socket.send(JSON.stringify({
                    type: 'add_friend',
                    friendId: addFriendInput.value
                }));
                addFriendModal.classList.remove('active');
                addFriendInput.value = '';
            }
        };
        
        editProfileBtn.onclick = () => {
            editName.value = currentUser.name || '';
            editBio.value = currentUser.bio || '';
            editProfileModal.classList.add('active');
        };
        
        editProfileCancel.onclick = () => editProfileModal.classList.remove('active');
        
        editProfileConfirm.onclick = () => {
            if (socket) {
                socket.send(JSON.stringify({
                    type: 'update_profile',
                    name: editName.value,
                    bio: editBio.value
                }));
                currentUser.name = editName.value;
                currentUser.bio = editBio.value;
                updateUIForUser();
            }
            editProfileModal.classList.remove('active');
        };
        
        sendChannelBtn.onclick = () => {
            if (socket && channelInput.value) {
                socket.send(JSON.stringify({
                    type: 'channel_message',
                    content: channelInput.value
                }));
                channelInput.value = '';
            }
        };
        
        searchContacts?.addEventListener('input', updateContacts);
        
        tabButtons.forEach(btn => {
            btn.onclick = () => showScreen(btn.dataset.tab);
        });

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        if (token) {
            connectWebSocket();
            showScreen('contacts');
        } else {
            showScreen('auth');
        }
    </script>
</body>
</html>



